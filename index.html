<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sterowanie Piecem Peletowym ESP32</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <!-- Biblioteka MQTT.js do komunikacji z brokerem MQTT -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--primary:#2c3e50;--secondary:#3498db;--danger:#e74c3c;--warning:#f39c12;--success:#2ecc71;--dark:#1a252f;--flame-on:#ff5722;--flame-off:#555;--igniter-heating:#ff9800;--igniter-ready:#9c27b0;--feeder-color:#8e44ad;--blower-color:#1abc9c;--maintenance-color:#9b59b6;--clean-color:#e67e22;--pellet-color:#d35400;--mqtt-connected:#2ecc71;--mqtt-disconnected:#e74c3c;--feeder-forward-color:#2ecc71; /* Green */ --feeder-pause-color:#e74c3c; /* Red */ --feeder-reverse-color:#9b59b6; /* Purple */}*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}body{background:linear-gradient(135deg,var(--dark),var(--primary));color:white;min-height:100vh;padding:20px;line-height:1.6;}.container{max-width:1200px;margin:0 auto;}header{text-align:center;padding:20px 0;margin-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.2);border-radius:15px;}h1{font-size:2.5rem;margin-bottom:10px;color:white;display:flex;align-items:center;justify-content:center;gap:15px;}.subtitle{font-size:1.1rem;color:#3498db;max-width:800px;margin:0 auto;}.dashboard{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;}@media (max-width:992px){.dashboard{grid-template-columns:1fr;}}.card{background:rgba(255,255,255,0.08);border-radius:15px;padding:25px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.15);box-shadow:0 10px 35px rgba(0,0,0,0.3);transition:all 0.3s ease;}.card:hover{transform:translateY(-5px);box-shadow:0 15px 40px rgba(0,0,0,0.4);}.card-title{font-size:1.5rem;margin-bottom:20px;color:#3498db;display:flex;align-items:center;gap:10px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1);}.card-title i{font-size:1.8rem;}.status-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;}.status-item{background:rgba(0,0,0,0.25);border-radius:12px;padding:18px;text-align:center;transition:transform 0.3s;}.status-item:hover{transform:scale(1.03);background:rgba(0,0,0,0.3);}.status-label{font-size:1rem;color:#bbb;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:8px;}.status-value{font-size:2rem;font-weight:bold;color:white;}.status-unit{font-size:1.2rem;color:#7f8c8d;}.progress-container{background:rgba(0,0,0,0.3);border-radius:10px;height:20px;margin:15px 0;overflow:hidden;}.progress-bar{height:100%;border-radius:10px;transition:width 0.5s ease;}.heating-bar{background:linear-gradient(90deg,#ff9800,#ff5722);}.ignition-bar{background:linear-gradient(90deg,#3498db,#2ecc71);}.feeder-bar{background:linear-gradient(90deg,var(--feeder-color),#9b59b6);}.blower-bar{background:linear-gradient(90deg,var(--blower-color),#16a085);}.maintenance-bar{background:linear-gradient(90deg,var(--maintenance-color),#8e44ad);}.clean-bar{background:linear-gradient(90deg,var(--clean-color),#d35400);}.control-group{margin-bottom:25px;}.slider-container{background:rgba(0,0,0,0.25);border-radius:12px;padding:18px;margin:18px 0;}.slider-label{display:flex;justify-content:space-between;margin-bottom:12px;font-size:1.1rem;}input[type="range"]{width:100%;height:30px;-webkit-appearance:none;background:rgba(255,255,255,0.1);border-radius:15px;outline:none;}input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:30px;height:30px;border-radius:50%;background:#3498db;cursor:pointer;box-shadow:0 0 10px rgba(52,152,219,0.5);transition:all 0.3s;}input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.1);background:#2980b9;}input[type="range"]:active{transform:translateY(1px);}button{padding:16px;border:none;border-radius:12px;background:#3498db;color:white;font-size:1.15rem;font-weight:bold;cursor:pointer;transition:all 0.3s;margin:8px 0;display:flex;align-items:center;justify-content:center;gap:10px;width:100%;}button:hover{background:#2980b9;transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,0.3);}button:active{transform:translateY(1px);}button.power-off{background:#e74c3c;}button.power-off:hover{background:#c0392b;}button.warning{background:#f39c12;}button.warning:hover{background:#e67e22;}button.success{background:#2ecc71;}button.success:hover{background:#27ae60;}.mode-buttons{display:flex;gap:12px;margin:18px 0;}.mode-button{flex:1;text-align:center;padding:16px;border-radius:12px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;display:flex;flex-direction:column;align-items:center;gap:10px;}.mode-button:hover{background:rgba(255,255,255,0.15);}.mode-button.active{background:#3498db;box-shadow:0 0 20px rgba(52,152,219,0.4);}.log{background:rgba(0,0,0,0.25);border-radius:12px;padding:18px;height:200px;overflow-y:auto;margin-top:20px;}.log-entry{padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);font-size:0.95rem;display:flex;}.log-time{color:#3498db;min-width:70px;font-weight:bold;}.chart-container{height:300px;margin-top:20px;background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;position:relative;}.tabs{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;}.tab{padding:10px 20px;border-radius:8px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;}.tab.active{background:#3498db;}.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;}.stat-card{background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.stat-title{font-size:1.1rem;margin-bottom:10px;color:#3498db;text-align:center;}.stat-value{font-size:1.8rem;font-weight:bold;text-align:center;margin:10px 0;}.stat-sub{display:flex;justify-content:space-between;font-size:0.9rem;color:#bbb;}.diagram{display:flex;justify-content:space-around;align-items:center;margin:25px 0;padding:20px;background:rgba(0,0,0,0.2);border-radius:15px;flex-wrap:wrap;gap:10px;}.diagram-component{text-align:center;position:relative;min-width:100px;}.diagram-component i{font-size:2.8rem;margin-bottom:10px;color:#3498db;}.diagram-arrow{font-size:2.5rem;color:#3498db;}.ignition-container{display:flex;flex-direction:column;align-items:center;margin:20px 0;}.flame-indicator{width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;transition:all 0.5s ease;margin-bottom:15px;position:relative;overflow:hidden;}.flame-indicator.on{background:var(--flame-on);box-shadow:0 0 30px var(--flame-on);animation:flamePulse 1.5s infinite;}.flame-indicator.off{background:var(--flame-off);}.igniter-indicator{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;background:var(--igniter-heating);opacity:0.8;animation:heatingPulse 2s infinite;}.igniter-indicator.ready{background:var(--igniter-ready);animation:readyPulse 1s infinite;}@keyframes flamePulse{0%{box-shadow:0 0 15px var(--flame-on);}50%{box-shadow:0 0 40px var(--flame-on);}100%{box-shadow:0 0 15px var(--flame-on);}}@keyframes heatingPulse{0%{box-shadow:0 0 10px var(--igniter-heating);opacity:0.6;}50%{box-shadow:0 0 25px var(--igniter-heating);opacity:0.9;}100%{box-shadow:0 0 10px var(--igniter-heating);opacity:0.6;}}@keyframes readyPulse{0%{box-shadow:0 0 10px var(--igniter-ready);opacity:0.7;}50%{box-shadow:0 0 30px var(--igniter-ready);opacity:1;}100%{box-shadow:0 0 10px var(--igniter-ready);opacity:0.7;}}.ignition-status{font-size:1.3rem;font-weight:bold;text-align:center;padding:10px 20px;border-radius:20px;margin-top:10px;}.ignition-status.heating{background:rgba(255,152,0,0.2);color:#ff9800;}.ignition-status.ready{background:rgba(156,39,176,0.2);color:#9c27b0;}.ignition-status.on{background:rgba(255,87,34,0.2);color:#ff5722;}.ignition-status.off{background:rgba(85,85,85,0.2);color:#bbb;}.ignition-timer{display:flex;align-items:center;justify-content:center;gap:10px;margin:15px 0;font-size:1.2rem;}.timer-value{font-weight:bold;color:#f39c12;min-width:40px;text-align:center;}.ignition-progress{display:flex;align-items:center;justify-content:center;gap:10px;margin:15px 0;}.progress-circle{width:100px;height:100px;border-radius:50%;background:conic-gradient(#ff9800 0%,#ff5722 0%,rgba(0,0,0,0.3) 0%);display:flex;align-items:center;justify-content:center;position:relative;}.progress-text{font-size:1.5rem;font-weight:bold;position:absolute;}.temperature-display{font-size:1.1rem;margin-top:5px;color:#ff9800;}footer{text-align:center;margin-top:40px;padding:25px;color:#7f8c8d;font-size:1rem;border-top:1px solid rgba(255,255,255,0.1);}.auto-clean{display:flex;align-items:center;gap:10px;margin:15px 0;background:rgba(0,0,0,0.25);border-radius:12px;padding:18px;justify-content:space-between;}.auto-clean-label{display:flex;align-items:center;gap:10px;font-size:1.1rem;}.clean-timer{background:rgba(255,255,255,0.1);border-radius:8px;padding:8px 15px;font-weight:bold;}.switch{position:relative;display:inline-block;width:60px;height:30px;}.switch input{opacity:0;width:0;height:0;}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:30px;}.slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%;}input:checked+.slider{background-color:#3498db;}input:checked+.slider:before{transform:translateX(30px);}.feeder-info,.blower-info{display:flex;align-items:center;gap:15px;margin:15px 0;}.feeder-icon,.blower-icon{font-size:2rem;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;}.feeder-icon{background:rgba(142,68,173,0.2);color:var(--feeder-color);}.blower-icon{background:rgba(26,188,156,0.2);color:var(--blower-color);}.feeder-details,.blower-details{flex:1;}.control-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-size:1.1rem;}.fixed-blower{background:rgba(0,0,0,0.25);border-radius:12px;padding:15px;text-align:center;margin-top:15px;}.status-indicator{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px;}.status-active{background-color:var(--success);box-shadow:0 0 8px var(--success);}.status-inactive{background-color:var(--danger);}.status-warning{background-color:var(--warning);box-shadow:0 0 8px var(--warning);}.status-ready{background-color:var(--igniter-ready);box-shadow:0 0 8px var(--igniter-ready);}.time-control{display:flex;justify-content:space-between;align-items:center;margin:10px 0;gap:15px;}.time-input{flex:1;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;text-align:center;}.time-input label{display:block;margin-bottom:5px;color:#3498db;font-weight:bold;}.time-input input{width:100%;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:white;text-align:center;font-size:1.1rem;}.feeder-cycle{display:flex;flex-direction:column;align-items:center;margin-top:15px;background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.cycle-progress{width:100%;height:20px;background:rgba(0,0,0,0.3);border-radius:10px;margin:10px 0;overflow:hidden;position:relative;}.cycle-progress-bar{height:100%;border-radius:10px;transition:width 0.5s;}.cycle-status{font-weight:bold;margin-top:5px;display:flex;align-items:center;gap:5px;}.cycle-status.on{color:#2ecc71;}.cycle-status.off{color:#e74c3c;}.maintenance-indicator{padding:5px 10px;border-radius:15px;font-weight:bold;}.maintenance-active{background:rgba(46,204,113,0.2);color:#2ecc71;}.maintenance-inactive{background:rgba(231,76,60,0.2);color:#e74c3c;}.edit-clean-container{background:rgba(0,0,0,0.25);border-radius:12px;padding:15px;margin-top:15px;}.edit-clean-header{display:flex;align-items:center;gap:10px;margin-bottom:15px;font-size:1.1rem;}.edit-clean-fields{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:center;}.edit-time-input{text-align:center;}.edit-time-input label{display:block;margin-bottom:5px;color:#3498db;}.edit-time-input input{width:100%;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:white;text-align:center;font-size:1.1rem;}#update-clean-btn{height:40px;align-self:flex-end;margin-bottom:5px;padding:8px 15px;font-size:0.9rem;}.notification-badge{position:absolute;top:-5px;right:-5px;background:var(--danger);color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:bold;}.notification-container{position:relative;}.blower-info-box{background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;margin-top:15px;text-align:center;}.blower-cycle{display:flex;flex-direction:column;align-items:center;margin-top:15px;background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.blower-status{font-weight:bold;margin-top:5px;display:flex;align-items:center;gap:5px;}.blower-status.on{color:#2ecc71;}.blower-status.off{color:#e74c3c;}.blower-progress{width:100%;height:20px;background:rgba(0,0,0,0.3);border-radius:10px;margin:10px 0;overflow:hidden;position:relative;}.blower-progress-bar{height:100%;background:linear-gradient(90deg,var(--blower-color),#16a085);transition:width 0.5s;}.control-btn{padding:8px 15px;border-radius:8px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;}.control-btn:hover{background:rgba(255,255,255,0.15);}.control-btn.active{background:#3498db;}.blower-mode-info{margin-top:10px;padding:8px;border-radius:8px;background:rgba(0,0,0,0.2);}.mode-direct{background:rgba(231,76,60,0.2);color:#e74c3c;}.mode-inverter{background:rgba(46,204,113,0.2);color:#2ecc71;}.system-status{display:flex;justify-content:center;gap:15px;margin-top:15px;}.status-badge{padding:8px 15px;border-radius:20px;font-weight:bold;display:flex;align-items:center;gap:8px;}.status-good{background:rgba(46,204,113,0.2);color:#2ecc71;}.status-warning{background:rgba(243,156,18,0.2);color:#f39c12;}.status-error{background:rgba(231,76,60,0.2);color:#e74c3c;}.device-status{display:flex;justify-content:space-around;margin-top:15px;padding:10px;background:rgba(0,0,0,0.2);border-radius:12px;}.status-item{text-align:center;}.chart-controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;}.dataset-toggle{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;background:rgba(255,255,255,0.1);cursor:pointer;}.dataset-toggle.active{background:rgba(52,152,219,0.3);}.chart-color-indicator{width:15px;height:15px;border-radius:50%;}.history-stats{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px;}.history-card{background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.history-title{font-size:1.1rem;margin-bottom:10px;color:#3498db;text-align:center;}.history-value{font-size:1.5rem;font-weight:bold;text-align:center;margin:10px 0;}.cost-calculation{background:rgba(0,0,0,0.15);border-radius:12px;padding:15px;margin-top:15px;}.cost-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);}.cost-total{font-weight:bold;font-size:1.2rem;margin-top:10px;padding-top:10px;border-top:2px solid rgba(255,255,255,0.2);}.efficiency-gauge{width:100%;height:30px;background:rgba(0,0,0,0.3);border-radius:15px;overflow:hidden;position:relative;}.gauge-fill{height:100%;background:linear-gradient(90deg,#3498db,#2ecc71);transition:width 0.5s;}.gauge-label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:white;font-weight:bold;text-shadow:0 0 3px rgba(0,0,0,0.8);}.chart-switcher{display:flex;gap:10px;margin-bottom:15px;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;}.chart-switch{padding:8px 15px;border-radius:20px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;}.chart-switch.active{background:rgba(52,152,219,0.3);}.zoom-controls{position:absolute;top:10px;right:10px;display:flex;gap:5px;z-index:10;background:rgba(0,0,0,0.5);border-radius:20px;padding:5px;}.zoom-btn{width:30px;height:30px;border-radius:50%;background:#3498db;color:white;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;font-size:18px;transition:background 0.3s;}.zoom-btn:hover{background:#2980b9;}.zoom-btn.reset{background:#e74c3c;}.zoom-btn.reset:hover{background:#c0392b;}.history-range{display:flex;gap:10px;margin-bottom:15px;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;}.history-btn{padding:8px 15px;border-radius:20px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;}.history-btn.active{background:rgba(52,152,219,0.3);}.tab-content{display:none;}.tab-content.active{display:block;}.instructions{background:rgba(0,0,0,0.2);border-radius:15px;padding:20px;margin-top:20px;}.instructions h3{color:#3498db;margin-bottom:15px;display:flex;align-items:center;gap:10px;}.instructions ul{padding-left:25px;}.instructions li{margin-bottom:10px;line-height:1.5;}.instructions strong{color:#3498db;}.controls{display:flex;justify-content:center;align-items:center;gap:0.8rem;margin:1.2rem 0;flex-wrap:wrap;}.control-btn{padding:0.6rem 1.2rem;background-color:rgba(0,0,0,0.25);border:2px solid var(--secondary);border-radius:30px;color:var(--secondary);font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:0.5rem;}.control-btn:hover{background-color:var(--secondary);color:white;}.date-display{font-weight:600;color:white;background-color:rgba(0,0,0,0.3);padding:0.5rem 1.2rem;border-radius:30px;min-width:250px;text-align:center;}.tab-btn{padding:0.7rem 1.2rem;background-color:rgba(0,0,0,0.25);border:none;border-radius:30px;cursor:pointer;font-weight:600;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;color:white;}.tab-btn.active{background-color:var(--secondary);color:white;}.tab-btn:hover:not(.active){background-color:rgba(255,255,255,0.15);}.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;margin-top:1.5rem;}.stat-card-monitor{background:linear-gradient(135deg,var(--secondary),var(--primary));color:white;padding:1rem;border-radius:8px;text-align:center;transition:transform 0.3s ease;}.stat-card-monitor:hover{transform:scale(1.03);}.stat-card-monitor .value{font-size:1.8rem;font-weight:700;margin:0.5rem 0;}.stat-card-monitor .label{font-size:0.9rem;opacity:0.9;display:flex;align-items:center;justify-content:center;gap:5px;}.stat-card-monitor i{font-size:1.2rem;}.correction-info{background:rgba(0,0,0,0.25);border-radius:12px;padding:15px;margin-top:15px;text-align:center;}.correction-value{font-size:1.5rem;font-weight:bold;color:#f39c12;}.correction-controls{display:flex;gap:10px;margin-top:10px;}.correction-input{flex:1;background:rgba(0,0,0,0.2);border:1px solid #f39c12;border-radius:8px;padding:8px;color:white;text-align:center;font-size:1.1rem;}.correction-btn{padding:8px 15px;border-radius:8px;background:#f39c12;color:white;border:none;cursor:pointer;font-weight:bold;transition:all 0.3s;}.correction-btn:hover{background:#e67e22;}.reset-stats-btn{background:#9b59b6;margin-top:15px;}.reset-stats-btn:hover{background:#8e44ad;}/* MQTT Configuration Panel */.mqtt-config{background:rgba(0,0,0,0.25);border-radius:15px;padding:20px;margin-bottom:20px;}.mqtt-config h3{color:#3498db;margin-bottom:15px;display:flex;align-items:center;gap:10px;}.mqtt-form{display:grid;grid-template-columns:1fr 1fr;gap:15px;}.mqtt-field{margin-bottom:15px;}.mqtt-field label{display:block;margin-bottom:5px;color:#3498db;font-weight:bold;}.mqtt-field input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(0,0,0,0.2);color:white;}.mqtt-actions{display:flex;gap:10px;margin-top:10px;grid-column:span 2;}.mqtt-status{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:rgba(0,0,0,0.3);margin-top:15px;}.mqtt-indicator{width:12px;height:12px;border-radius:50%;background-color:var(--mqtt-disconnected);}.mqtt-indicator.connected{background-color:var(--mqtt-connected);box-shadow:0 0 8px var(--mqtt-connected);}.mqtt-topic-list{margin-top:20px;background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.topic-item{padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);font-family:monospace;display:flex;justify-content:space-between;}.topic-item:last-child{border-bottom:none;}.mqtt-log{background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;margin-top:15px;height:150px;overflow-y:auto;}.mqtt-log-entry{font-family:monospace;font-size:0.9rem;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.1);}.mqtt-log-entry:last-child{border-bottom:none;}.mqtt-log-topic{color:#3498db;font-weight:bold;}.mqtt-log-message{color:#f39c12;}
        /* Dodano dla poprawy obsługi dotyku na canvas */
        canvas {
            touch-action: none;
        }

        /* Styles for new blower controls */
        .blower-manual-controls {
            display: none; /* Hidden by default, shown when blowerManualToggle is checked */
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-fire"></i> Symulator Pieca Peletowego z MQTT</h1>
            <div class="subtitle">Sterowanie przez ESP32 z obsługą pełnej historii danych i korektą</div>
            <div class="system-status">
                <div class="status-badge status-good">
                    <i class="fas fa-history"></i>
                    Pełna historia danych
                </div>
                <div class="status-badge status-good">
                    <i class="fas fa-wifi"></i>
                    Sterowanie przez MQTT
                </div>
                <div class="status-badge status-good">
                    <i class="fas fa-microchip"></i>
                    Kompatybilne z ESP32
                </div>
            </div>
        </header>
        
        <!-- MQTT Configuration Panel -->
        <div class="mqtt-config">
            <h3><i class="fas fa-wifi"></i> Konfiguracja połączenia MQTT</h3>
            <div class="mqtt-form">
                <div class="mqtt-field">
                    <label for="mqtt-broker">Adres brokera MQTT</label>
                    <input type="text" id="mqtt-broker" value="broker.emqx.io">
                </div>
                <div class="mqtt-field">
                    <label for="mqtt-port">Port</label>
                    <input type="number" id="mqtt-port" value="8084">
                </div>
                <div class="mqtt-field">
                    <label for="mqtt-username">Nazwa użytkownika</label>
                    <input type="text" id="mqtt-username" value="agentsan007">
                </div>
                <div class="mqtt-field">
                    <label for="mqtt-password">Hasło</label>
                    <input type="password" id="mqtt-password" value="Sanders24*">
                </div>
                <div class="mqtt-actions">
                    <button id="mqtt-connect-btn" class="success">
                        <i class="fas fa-plug"></i> Połącz
                    </button>
                    <button id="mqtt-disconnect-btn" class="danger">
                        <i class="fas fa-plug"></i> Rozłącz
                    </button>
                </div>
            </div>
            
            <div class="mqtt-status">
                <div class="mqtt-indicator connected" id="mqtt-status-indicator"></div>
                <span id="mqtt-status-text">Połączono</span>
            </div>
            
            <div class="mqtt-topic-list">
                <h4><i class="fas fa-list"></i> Aktywne tematy</h4>
                <div class="topic-item">
                    <span>pellet/boiler/state</span>
                    <span>Publikowanie stanu</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/control</span>
                    <span>Odbieranie poleceń</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/target_temp</span>
                    <span>Ustawianie temperatury</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/power</span>
                    <span>Włączanie/wyłączanie</span>
                </div>
            </div>
            
            <div class="mqtt-log">
                <h4><i class="fas fa-terminal"></i> Log komunikacji MQTT</h4>
                <div id="mqtt-log"><div class="mqtt-log-entry"><span class="mqtt-log-time">[05:11:59]</span> <span class="mqtt-log-topic">pellet/boiler/control</span>: <span class="mqtt-log-message">{"command":"power"}</span></div><div class="mqtt-log-entry"><span class="mqtt-log-time">[05:11:55]</span> <span class="mqtt-log-topic">MQTT</span>: <span class="mqtt-log-message">Subskrybowano: pellet/boiler/state</span></div><div class="mqtt-log-entry"><span class="mqtt-log-time">[05:11:54]</span> <span class="mqtt-log-topic">MQTT</span>: <span class="mqtt-log-message">Połączono z brokerem</span></div></div>
            </div>
        </div>
        
        <div class="dashboard">
            <!-- Left column - status and control -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-fire"></i> Sterowanie Piecem</h2>
                
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">
                            <i class="fas fa-temperature-high"></i> Temperatura wody
                            <span class="status-indicator" id="water-status"></span>
                        </div>
                        <div class="status-value" id="water-temp">73.2°C</div>
                        <div class="progress-container">
                            <div class="progress-bar ignition-bar" id="water-progress" style="width: 95.1074%;"></div>
                        </div>
                        <div class="status-label">Cel: <span id="target-temp-display-main">77</span>°C</div>
                        
                        <!-- Device status -->
                        <div class="device-status">
                            <div class="status-item">
                                <div class="status-label">
                                    <i class="fas fa-wind"></i> Dmuchawa
                                </div>
                                <span class="status-indicator status-active" id="blower-status-indicator-mini"></span>
                            </div>
                            <div class="status-item">
                                <div class="status-label">
                                    <i class="fas fa-conveyor-belt"></i> Podajnik
                                </div>
                                <span class="status-indicator status-inactive" id="feeder-status-indicator-mini"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-home"></i> Temperatura pokojowa</div>
                        <div class="status-value" id="room-temp">24.0°C</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-fire"></i> Temperatura palnika</div>
                        <div class="status-value" id="burner-temp">63.4°C</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-smoke"></i> Temperatura spalin</div>
                        <div class="status-value" id="exhaust-temp">86.4°C</div>
                    </div>
                </div>
                
                <div class="control-group">
                    <button id="power-btn" class="success"><i class="fas fa-power-off"></i> WŁĄCZONY</button>
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span><i class="fas fa-thermometer-half"></i> Temperatura docelowa:</span>
                        <span id="target-slider-display">70°C</span>
                    </div>
                    <input type="range" id="target-slider" min="40" max="85" value="70">
                </div>
                
                <!-- Advanced feeder control -->
                <div class="slider-container">
                    <div class="control-header">
                        <i class="fas fa-conveyor-belt" style="color: var(--feeder-color);"></i>
                        <span>Zaawansowane sterowanie podajnikiem</span>
                    </div>
                    
                    <div class="time-control">
                        <div class="time-input">
                            <label for="feed-time">Czas podawania (s)</label>
                            <input type="number" id="feed-time" min="1" value="5">
                        </div>
                        
                        <div class="time-input">
                            <label for="pause-time">Czas przerwy (s)</label>
                            <input type="number" id="pause-time" min="1" value="30">
                        </div>
                    </div>
                    
                    <div class="feeder-cycle">
                        <div class="cycle-status off" id="feeder-status"><span class="status-indicator status-inactive"></span> PODAJNIK: PRZERWA</div>
                        <div class="cycle-progress">
                            <div class="cycle-progress-bar" id="cycle-progress-bar" style="width: 8.33333%; background: var(--feeder-pause-color);"></div>
                        </div>
                        <div class="status-label">Pozostało: <span id="cycle-timer">55s do końca</span></div>
                    </div>
                    
                    <div class="status-label">Średnia ilość peletu: <span id="pellet-amount">0.10</span> kg/h</div>
                </div>
                
                <!-- Flame maintenance mode -->
                <div class="slider-container">
                    <div class="control-header">
                        <i class="fas fa-fire-alt" style="color: var(--maintenance-color);"></i>
                        <span>Tryb podtrzymania płomienia</span>
                    </div>
                    
                    <div class="time-control">
                        <div class="time-input">
                            <label for="maintenance-feed">Podawanie (s)</label>
                            <input type="number" id="maintenance-feed" min="1" max="10" value="2">
                        </div>
                        
                        <div class="time-input">
                            <label for="maintenance-pause">Przerwa (s)</label>
                            <input type="number" id="maintenance-pause" min="10" max="14400" value="60">
                        </div>
                    </div>
                    
                    <div class="auto-clean">
                        <div class="auto-clean-label">
                            <i class="fas fa-fire-alt"></i>
                            <span>Status trybu podtrzymania:</span>
                        </div>
                        <span class="maintenance-indicator maintenance-inactive" id="maintenance-status-display">Nieaktywny</span>
                    </div>
                    <div class="status-label">Pozostało do czyszczenia: <span id="clean-timer">23:55:00</span></div>
                </div>
            </div>
            
            <!-- Right column - charts and logs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> Analiza Danych</h2>
                
                <div class="chart-controls">
                    <div class="dataset-toggle active" data-dataset="water_temp">
                        <span class="chart-color-indicator" style="background-color: #3498db;"></span>
                        Woda
                    </div>
                    <div class="dataset-toggle" data-dataset="room_temp">
                        <span class="chart-color-indicator" style="background-color: #f39c12;"></span>
                        Pokój
                    </div>
                    <div class="dataset-toggle" data-dataset="burner_temp">
                        <span class="chart-color-indicator" style="background-color: #e74c3c;"></span>
                        Palnik
                    </div>
                    <div class="dataset-toggle" data-dataset="exhaust_temp">
                        <span class="chart-color-indicator" style="background-color: #9b59b6;"></span>
                        Spaliny
                    </div>
                    <div class="dataset-toggle" data-dataset="target_temp">
                        <span class="chart-color-indicator" style="background-color: #2ecc71;"></span>
                        Cel
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="temperatureChart"></canvas>
                    <div class="zoom-controls">
                        <button class="zoom-btn" id="zoom-in-btn">+</button>
                        <button class="zoom-btn" id="zoom-out-btn">-</button>
                        <button class="zoom-btn reset" id="zoom-reset-btn"><i class="fas fa-redo"></i></button>
                    </div>
                </div>
                
                <div class="history-range">
                    <button class="history-btn active" data-range="1h">1h</button>
                    <button class="history-btn" data-range="6h">6h</button>
                    <button class="history-btn" data-range="24h">24h</button>
                    <button class="history-btn" data-range="7d">7d</button>
                </div>
                
                <div class="history-stats">
                    <div class="history-card">
                        <div class="history-title">Średnia temp. wody</div>
                        <div class="history-value" id="avg-water-temp">--</div>
                    </div>
                    <div class="history-card">
                        <div class="history-title">Maks. temp. wody</div>
                        <div class="history-value" id="max-water-temp">--</div>
                    </div>
                    <div class="history-card">
                        <div class="history-title">Min. temp. wody</div>
                        <div class="history-value" id="min-water-temp">--</div>
                    </div>
                    <div class="history-card">
                        <div class="history-title">Zużycie paliwa (całość)</div>
                        <div class="history-value" id="total-fuel-consumption">-- kg</div>
                    </div>
                </div>
                
                <div class="cost-calculation">
                    <div class="cost-row">
                        <span>Cena peletu (PLN/kg):</span>
                        <input type="number" id="pellet-price" value="1.2" step="0.1" style="width: 80px; background: rgba(0,0,0,0.2); border: none; color: white; border-radius: 5px; text-align: center;">
                    </div>
                    <div class="cost-row">
                        <span>Szacowany koszt:</span>
                        <span id="estimated-cost">-- PLN</span>
                    </div>
                    <div class="cost-total">
                        <span>Szacowany dzienny koszt:</span>
                        <span id="daily-cost">-- PLN</span>
                    </div>
                </div>
                
                <div class="efficiency-gauge">
                    <div class="gauge-fill" style="width: 85%;"></div>
                    <div class="gauge-label" id="efficiency-value">85%</div>
                </div>
            </div>
        </div>

        <footer>
            Symulator Pieca Peletowego v1.0 &copy; 2024
        </footer>
    </div>

    <script>
        // Global variables for MQTT client and topics
        let client = null;
        let isMqttConnected = false;

        // MQTT Topics - zgodne z tymi w kodzie ESP32
        const MQTT_TOPICS = {
            state: "pellet/boiler/state",
            control: "pellet/boiler/control",
            targetTemp: "pellet/boiler/target_temp",
            power: "pellet/boiler/power"
        };

        // --- Elementy DOM ---
        const mqttBrokerInput = document.getElementById('mqtt-broker');
        const mqttPortInput = document.getElementById('mqtt-port');
        const mqttUsernameInput = document.getElementById('mqtt-username');
        const mqttPasswordInput = document.getElementById('mqtt-password');
        const mqttConnectBtn = document.getElementById('mqtt-connect-btn');
        const mqttDisconnectBtn = document.getElementById('mqtt-disconnect-btn');
        const mqttStatusIndicator = document.getElementById('mqtt-status-indicator');
        const mqttStatusText = document.getElementById('mqtt-status-text');
        const mqttLogDiv = document.getElementById('mqtt-log');

        const powerBtn = document.getElementById('power-btn');
        const targetSlider = document.getElementById('target-slider');
        const targetSliderDisplay = document.getElementById('target-slider-display');
        const targetTempDisplayMain = document.getElementById('target-temp-display-main'); // Do aktualizacji na głównym panelu

        const waterTempDisplay = document.getElementById('water-temp');
        const roomTempDisplay = document.getElementById('room-temp');
        const burnerTempDisplay = document.getElementById('burner-temp');
        const exhaustTempDisplay = document.getElementById('exhaust-temp');
        const waterProgressBar = document.getElementById('water-progress');

        // --- Funkcje pomocnicze ---
        function appendMqttLog(topic, message) {
            const now = new Date();
            const time = now.toTimeString().split(' ')[0].substring(0, 8);
            const logEntry = document.createElement('div');
            logEntry.classList.add('mqtt-log-entry');
            logEntry.innerHTML = `<span class="mqtt-log-time">[${time}]</span> <span class="mqtt-log-topic">${topic}</span>: <span class="mqtt-log-message">${message}</span>`;
            mqttLogDiv.prepend(logEntry); // Dodaj na początek
            if (mqttLogDiv.children.length > 50) { // Limit logów do 50
                mqttLogDiv.removeChild(mqttLogDiv.lastChild);
            }
        }

        function updateMqttStatus(connected) {
            isMqttConnected = connected;
            if (connected) {
                mqttStatusIndicator.classList.remove('disconnected');
                mqttStatusIndicator.classList.add('connected');
                mqttStatusText.textContent = "Połączono";
                appendMqttLog("MQTT", "Połączono z brokerem");
            } else {
                mqttStatusIndicator.classList.remove('connected');
                mqttStatusIndicator.classList.add('disconnected');
                mqttStatusText.textContent = "Rozłączono";
                appendMqttLog("MQTT", "Rozłączono z brokerem");
            }
            mqttConnectBtn.disabled = connected;
            mqttDisconnectBtn.disabled = !connected;
            powerBtn.disabled = !connected; // Wyłącz przyciski sterowania, gdy brak połączenia
            targetSlider.disabled = !connected;
        }

        // --- Połączenie / Rozłączenie MQTT ---
        function connectMQTT() {
            const broker = mqttBrokerInput.value;
            const port = mqttPortInput.value;
            const username = mqttUsernameInput.value;
            const password = mqttPasswordInput.value;

            const connectOptions = {
                username: username,
                password: password,
                port: parseInt(port)
            };

            client = mqtt.connect(`ws://${broker}:${port}/mqtt`, connectOptions);

            client.on('connect', () => {
                updateMqttStatus(true);
                // Subskrybuj tematy, na których ESP32 publikuje stan
                client.subscribe(MQTT_TOPICS.state, (err) => {
                    if (!err) {
                        appendMqttLog("MQTT", `Subskrybowano: ${MQTT_TOPICS.state}`);
                    } else {
                        appendMqttLog("MQTT ERROR", `Błąd subskrypcji ${MQTT_TOPICS.state}: ${err}`);
                    }
                });
            });

            client.on('message', (topic, message) => {
                const msgString = message.toString();
                appendMqttLog(topic, msgString);
                
                // Obsługa wiadomości o stanie pieca z ESP32
                if (topic === MQTT_TOPICS.state) {
                    try {
                        const state = JSON.parse(msgString);
                        // Aktualizacja UI na podstawie otrzymanych danych
                        waterTempDisplay.textContent = `${state.water_temp.toFixed(1)}°C`;
                        roomTempDisplay.textContent = `${state.room_temp.toFixed(1)}°C`;
                        burnerTempDisplay.textContent = `${state.burner_temp.toFixed(1)}°C`;
                        exhaustTempDisplay.textContent = `${state.exhaust_temp.toFixed(1)}°C`;
                        targetTempDisplayMain.textContent = `${state.target_temp.toFixed(1)}`; // Główny wyświetlacz celu

                        // Aktualizacja paska postępu wody (przykładowo, na podstawie 100°C max)
                        const waterProgress = (state.water_temp / 100) * 100;
                        waterProgressBar.style.width = `${waterProgress}%`;

                        // Aktualizacja stanu przycisku włączania/wyłączania
                        if (state.power === "ON") {
                            powerBtn.textContent = "WŁĄCZONY";
                            powerBtn.classList.remove('power-off');
                            powerBtn.classList.add('success');
                        } else {
                            powerBtn.textContent = "WYŁĄCZONY";
                            powerBtn.classList.remove('success');
                            powerBtn.classList.add('power-off');
                        }

                        // Synchronizacja suwaka temperatury z wartością z ESP32
                        targetSlider.value = state.target_temp;
                        targetSliderDisplay.textContent = `${state.target_temp.toFixed(0)}°C`;

                    } catch (e) {
                        appendMqttLog("JSON PARSE ERROR", `Nie udało się sparsować wiadomości: ${e.message}`);
                    }
                }
                // Tutaj możesz dodać obsługę innych tematów, jeśli ESP32 będzie publikować na nie informacje
            });

            client.on('error', (err) => {
                appendMqttLog("MQTT ERROR", `Błąd połączenia: ${err.message}`);
                updateMqttStatus(false);
                client.end(); // Zamykamy połączenie w przypadku błędu
            });

            client.on('close', () => {
                updateMqttStatus(false);
            });
        }

        function disconnectMQTT() {
            if (client) {
                client.end();
            }
        }

        function publishMqttMessage(topic, message) {
            if (isMqttConnected) {
                client.publish(topic, message);
                appendMqttLog(topic, message);
            } else {
                appendMqttLog("MQTT ERROR", "Nie połączono z brokerem MQTT!");
                console.warn("MQTT client not connected. Message not sent.");
            }
        }

        // --- Obsługa zdarzeń DOM ---
        document.addEventListener('DOMContentLoaded', () => {
            // Połączenie/rozłączenie MQTT
            mqttConnectBtn.addEventListener('click', connectMQTT);
            mqttDisconnectBtn.addEventListener('click', disconnectMQTT);

            // Obsługa przycisku WŁĄCZ/WYŁĄCZ piec
            powerBtn.addEventListener('click', () => {
                // Sprawdź obecny stan pieca (na podstawie tekstu na przycisku)
                const currentState = powerBtn.textContent.trim();
                let newState;

                if (currentState === "WŁĄCZONY") {
                    newState = "OFF";
                } else {
                    newState = "ON";
                }
                // Wysyłamy komendę do ESP32 przez MQTT
                publishMqttMessage(MQTT_TOPICS.power, newState);
            });

            // Obsługa suwaka temperatury docelowej
            targetSlider.addEventListener('input', () => {
                const temp = parseFloat(targetSlider.value);
                targetSliderDisplay.textContent = `${temp}°C`;
                // Wysyłamy nową temperaturę docelową do ESP32 przez MQTT
                publishMqttMessage(MQTT_TOPICS.targetTemp, temp.toFixed(1));
            });

            // Początkowe połączenie z MQTT przy załadowaniu strony
            connectMQTT();

            // Ustawienie początkowej wartości wyświetlacza suwaka
            targetSliderDisplay.textContent = `${targetSlider.value}°C`;
        });
    </script>

</body>
</html>
