<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sterowanie Piecem Peletowym ESP32</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <!-- Biblioteka MQTT.js do komunikacji z brokerem MQTT przez WebSockets -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Twoje istniejące style CSS - BEZ ZMIAN W STYLU */
        :root{--primary:#2c3e50;--secondary:#3498db;--danger:#e74c3c;--warning:#f39c12;--success:#2ecc71;--dark:#1a252f;--flame-on:#ff5722;--flame-off:#555;--igniter-heating:#ff9800;--igniter-ready:#9c27b0;--feeder-color:#8e44ad;--blower-color:#1abc9c;--maintenance-color:#9b59b6;--clean-color:#e67e22;--pellet-color:#d35400;--mqtt-connected:#2ecc71;--mqtt-disconnected:#e74c3c;--feeder-forward-color:#2ecc71; /* Green */ --feeder-pause-color:#e74c3c; /* Red */ --feeder-reverse-color:#9b59b6; /* Purple */}*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}body{background:linear-gradient(135deg,var(--dark),var(--primary));color:white;min-height:100vh;padding:20px;line-height:1.6;}.container{max-width:1200px;margin:0 auto;}header{text-align:center;padding:20px 0;margin-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.2);border-radius:15px;}h1{font-size:2.5rem;margin-bottom:10px;color:white;display:flex;align-items:center;justify-content:center;gap:15px;}.subtitle{font-size:1.1rem;color:#3498db;max-width:800px;margin:0 auto;}.dashboard{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;}@media (max-width:992px){.dashboard{grid-template-columns:1fr;}}.card{background:rgba(255,255,255,0.08);border-radius:15px;padding:25px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.15);box-shadow:0 10px 35px rgba(0,0,0,0.3);transition:all 0.3s ease;}.card:hover{transform:translateY(-5px);box-shadow:0 15px 40px rgba(0,0,0,0.4);}.card-title{font-size:1.5rem;margin-bottom:20px;color:#3498db;display:flex;align-items:center;gap:10px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1);}.card-title i{font-size:1.8rem;}.status-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;}.status-item{background:rgba(0,0,0,0.25);border-radius:12px;padding:18px;text-align:center;transition:transform 0.3s;}.status-item:hover{transform:scale(1.03);background:rgba(0,0,0,0.3);}.status-label{font-size:1rem;color:#bbb;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:8px;}.status-value{font-size:2rem;font-weight:bold;color:white;}.status-unit{font-size:1.2rem;color:#7f8c8d;}.progress-container{background:rgba(0,0,0,0.3);border-radius:10px;height:20px;margin:15px 0;overflow:hidden;}.progress-bar{height:100%;border-radius:10px;transition:width 0.5s ease;}.heating-bar{background:linear-gradient(90deg,#ff9800,#ff5722);}.ignition-bar{background:linear-gradient(90deg,#3498db,#2ecc71);}.feeder-bar{background:linear-gradient(90deg,var(--feeder-color),#9b59b6);}.blower-bar{background:linear-gradient(90deg,var(--blower-color),#16a085);}.maintenance-bar{background:linear-gradient(90deg,var(--maintenance-color),#8e44ad);}.clean-bar{background:linear-gradient(90deg,var(--clean-color),#d35400);}.control-group{margin-bottom:25px;}.slider-container{background:rgba(0,0,0,0.25);border-radius:12px;padding:18px;margin:18px 0;}.slider-label{display:flex;justify-content:space-between;margin-bottom:12px;font-size:1.1rem;}input[type="range"]{width:100%;height:30px;-webkit-appearance:none;background:rgba(255,255,255,0.1);border-radius:15px;outline:none;}input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:30px;height:30px;border-radius:50%;background:#3498db;cursor:pointer;box-shadow:0 0 10px rgba(52,152,219,0.5);transition:all 0.3s;}input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.1);background:#2980b9;}input[type="range"]:active{transform:translateY(1px);}button{padding:16px;border:none;border-radius:12px;background:#3498db;color:white;font-size:1.15rem;font-weight:bold;cursor:pointer;transition:all 0.3s;margin:8px 0;display:flex;align-items:center;justify-content:center;gap:10px;width:100%;}button:hover{background:#2980b9;transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,0.3);}button:active{transform:translateY(1px);}button.power-off{background:#e74c3c;}button.power-off:hover{background:#c0392b;}button.warning{background:#f39c12;}button.warning:hover{background:#e67e22;}button.success{background:#2ecc71;}button.success:hover{background:#27ae60;}.mode-buttons{display:flex;gap:12px;margin:18px 0;}.mode-button{flex:1;text-align:center;padding:16px;border-radius:12px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;display:flex;flex-direction:column;align-items:center;gap:10px;}.mode-button:hover{background:rgba(255,255,255,0.15);}.mode-button.active{background:#3498db;box-shadow:0 0 20px rgba(52,152,219,0.4);}.log{background:rgba(0,0,0,0.25);border-radius:12px;padding:18px;height:200px;overflow-y:auto;margin-top:20px;}.log-entry{padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);font-size:0.95rem;display:flex;}.log-time{color:#3498db;min-width:70px;font-weight:bold;}.chart-container{height:300px;margin-top:20px;background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;position:relative;}.tabs{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;}.tab{padding:10px 20px;border-radius:8px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;}.tab.active{background:#3498db;}.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;}.stat-card{background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.stat-title{font-size:1.1rem;margin-bottom:10px;color:#3498db;text-align:center;}.stat-value{font-size:1.8rem;font-weight:bold;text-align:center;margin:10px 0;}.stat-sub{display:flex;justify-content:space-between;font-size:0.9rem;color:#bbb;}.diagram{display:flex;justify-content:space-around;align-items:center;margin:25px 0;padding:20px;background:rgba(0,0,0,0.2);border-radius:15px;flex-wrap:wrap;gap:10px;}.diagram-component{text-align:center;position:relative;min-width:100px;}.diagram-component i{font-size:2.8rem;margin-bottom:10px;color:#3498db;}.diagram-arrow{font-size:2.5rem;color:#3498db;}.ignition-container{display:flex;flex-direction:column;align-items:center;margin:20px 0;}.flame-indicator{width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;transition:all 0.5s ease;margin-bottom:15px;position:relative;overflow:hidden;}.flame-indicator.on{background:var(--flame-on);box-shadow:0 0 30px var(--flame-on);animation:flamePulse 1.5s infinite;}.flame-indicator.off{background:var(--flame-off);}.igniter-indicator{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;background:var(--igniter-heating);opacity:0.8;animation:heatingPulse 2s infinite;}.igniter-indicator.ready{background:var(--igniter-ready);animation:readyPulse 1s infinite;}@keyframes flamePulse{0%{box-shadow:0 0 15px var(--flame-on);}50%{box-shadow:0 0 40px var(--flame-on);}100%{box-shadow:0 0 15px var(--flame-on);}}@keyframes heatingPulse{0%{box-shadow:0 0 10px var(--igniter-heating);opacity:0.6;}50%{box-shadow:0 0 25px var(--igniter-heating);opacity:0.9;}100%{box-shadow:0 0 10px var(--igniter-heating);opacity:0.6;}}@keyframes readyPulse{0%{box-shadow:0 0 10px var(--igniter-ready);opacity:0.7;}50%{box-shadow:0 0 30px var(--igniter-ready);opacity:1;}100%{box-shadow:0 0 10px var(--igniter-ready);opacity:0.7;}}.ignition-status{font-size:1.3rem;font-weight:bold;text-align:center;padding:10px 20px;border-radius:20px;margin-top:10px;}.ignition-status.heating{background:rgba(255,152,0,0.2);color:#ff9800;}.ignition-status.ready{background:rgba(156,39,176,0.2);color:#9c27b0;}.ignition-status.on{background:rgba(255,87,34,0.2);color:#ff5722;}.ignition-status.off{background:rgba(85,85,85,0.2);color:#bbb;}.ignition-timer{display:flex;align-items:center;justify-content:center;gap:10px;margin:15px 0;font-size:1.2rem;}.timer-value{font-weight:bold;color:#f39c12;min-width:40px;text-align:center;}.ignition-progress{display:flex;align-items:center;justify-content:center;gap:10px;margin:15px 0;}.progress-circle{width:100px;height:100px;border-radius:50%;background:conic-gradient(#ff9800 0%,#ff5722 0%,rgba(0,0,0,0.3) 0%);display:flex;align-items:center;justify-content:center;position:relative;}.progress-text{font-size:1.5rem;font-weight:bold;position:absolute;}.temperature-display{font-size:1.1rem;margin-top:5px;color:#ff9800;}footer{text-align:center;margin-top:40px;padding:25px;color:#7f8c8d;font-size:1rem;border-top:1px solid rgba(255,255,255,0.1);}.auto-clean{display:flex;align-items:center;gap:10px;margin:15px 0;background:rgba(0,0,0,0.25);border-radius:12px;padding:18px;justify-content:space-between;}.auto-clean-label{display:flex;align-items:center;gap:10px;font-size:1.1rem;}.clean-timer{background:rgba(255,255,255,0.1);border-radius:8px;padding:8px 15px;font-weight:bold;}.switch{position:relative;display:inline-block;width:60px;height:30px;}.switch input{opacity:0;width:0;height:0;}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:30px;}.slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%;}input:checked+.slider{background-color:#3498db;}input:checked+.slider:before{transform:translateX(30px);}.feeder-info,.blower-info{display:flex;align-items:center;gap:15px;margin:15px 0;}.feeder-icon,.blower-icon{font-size:2rem;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;}.feeder-icon{background:rgba(142,68,173,0.2);color:var(--feeder-color);}.blower-icon{background:rgba(26,188,156,0.2);color:var(--blower-color);}.feeder-details,.blower-details{flex:1;}.control-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-size:1.1rem;}.fixed-blower{background:rgba(0,0,0,0.25);border-radius:12px;padding:15px;text-align:center;margin-top:15px;}.status-indicator{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px;}.status-active{background-color:var(--success);box-shadow:0 0 8px var(--success);}.status-inactive{background-color:var(--danger);}.status-warning{background-color:var(--warning);box-shadow:0 0 8px var(--warning);}.status-ready{background-color:var(--igniter-ready);box-shadow:0 0 8px var(--igniter-ready);}.time-control{display:flex;justify-content:space-between;align-items:center;margin:10px 0;gap:15px;}.time-input{flex:1;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;text-align:center;}.time-input label{display:block;margin-bottom:5px;color:#3498db;font-weight:bold;}.time-input input{width:100%;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:white;text-align:center;font-size:1.1rem;}.feeder-cycle{display:flex;flex-direction:column;align-items:center;margin-top:15px;background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.cycle-progress{width:100%;height:20px;background:rgba(0,0,0,0.3);border-radius:10px;margin:10px 0;overflow:hidden;position:relative;}.cycle-progress-bar{height:100%;border-radius:10px;transition:width 0.5s;}.cycle-status{font-weight:bold;margin-top:5px;display:flex;align-items:center;gap:5px;}.cycle-status.on{color:#2ecc71;}.cycle-status.off{color:#e74c3c;}.maintenance-indicator{padding:5px 10px;border-radius:15px;font-weight:bold;}.maintenance-active{background:rgba(46,204,113,0.2);color:#2ecc71;}.maintenance-inactive{background:rgba(231,76,60,0.2);color:#e74c3c;}.edit-clean-container{background:rgba(0,0,0,0.25);border-radius:12px;padding:15px;margin-top:15px;}.edit-clean-header{display:flex;align-items:center;gap:10px;margin-bottom:15px;font-size:1.1rem;}.edit-clean-fields{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:center;}.edit-time-input{text-align:center;}.edit-time-input label{display:block;margin-bottom:5px;color:#3498db;}.edit-time-input input{width:100%;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:white;text-align:center;font-size:1.1rem;}#update-clean-btn{height:40px;align-self:flex-end;margin-bottom:5px;padding:8px 15px;font-size:0.9rem;}.notification-badge{position:absolute;top:-5px;right:-5px;background:var(--danger);color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:bold;}.notification-container{position:relative;}.blower-info-box{background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;margin-top:15px;text-align:center;}.blower-cycle{display:flex;flex-direction:column;align-items:center;margin-top:15px;background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.blower-status{font-weight:bold;margin-top:5px;display:flex;align-items:center;gap:5px;}.blower-status.on{color:#2ecc71;}.blower-status.off{color:#e74c3c;}.blower-progress{width:100%;height:20px;background:rgba(0,0,0,0.3);border-radius:10px;margin:10px 0;overflow:hidden;position:relative;}.blower-progress-bar{height:100%;background:linear-gradient(90deg,var(--blower-color),#16a085);transition:width 0.5s;}.control-btn{padding:8px 15px;border-radius:8px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;}.control-btn:hover{background:rgba(255,255,255,0.15);}.control-btn.active{background:#3498db;}.blower-mode-info{margin-top:10px;padding:8px;border-radius:8px;background:rgba(0,0,0,0.2);}.mode-direct{background:rgba(231,76,60,0.2);color:#e74c3c;}.mode-inverter{background:rgba(46,204,113,0.2);color:#2ecc71;}.system-status{display:flex;justify-content:center;gap:15px;margin-top:15px;}.status-badge{padding:8px 15px;border-radius:20px;font-weight:bold;display:flex;align-items:center;gap:8px;}.status-good{background:rgba(46,204,113,0.2);color:#2ecc71;}.status-warning{background:rgba(243,156,18,0.2);color:#f39c12;}.status-error{background:rgba(231,76,60,0.2);color:#e74c3c;}.device-status{display:flex;justify-content:space-around;margin-top:15px;padding:10px;background:rgba(0,0,0,0.2);border-radius:12px;}.status-item{text-align:center;}.chart-controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;}.dataset-toggle{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;background:rgba(255,255,255,0.1);cursor:pointer;}.dataset-toggle.active{background:rgba(52,152,219,0.3);}.chart-color-indicator{width:15px;height:15px;border-radius:50%;}.history-stats{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px;}.history-card{background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.history-title{font-size:1.1rem;margin-bottom:10px;color:#3498db;text-align:center;}.history-value{font-size:1.5rem;font-weight:bold;text-align:center;margin:10px 0;}.cost-calculation{background:rgba(0,0,0,0.15);border-radius:12px;padding:15px;margin-top:15px;}.cost-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);}.cost-total{font-weight:bold;font-size:1.2rem;margin-top:10px;padding-top:10px;border-top:2px solid rgba(255,255,255,0.2);}.efficiency-gauge{width:100%;height:30px;background:rgba(0,0,0,0.3);border-radius:15px;overflow:hidden;position:relative;}.gauge-fill{height:100%;background:linear-gradient(90deg,#3498db,#2ecc71);transition:width 0.5s;}.gauge-label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:white;font-weight:bold;text-shadow:0 0 3px rgba(0,0,0,0.8);}.chart-switcher{display:flex;gap:10px;margin-bottom:15px;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;}.chart-switch{padding:8px 15px;border-radius:20px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;}.chart-switch.active{background:rgba(52,152,219,0.3);}.zoom-controls{position:absolute;top:10px;right:10px;display:flex;gap:5px;z-index:10;background:rgba(0,0,0,0.5);border-radius:20px;padding:5px;}.zoom-btn{width:30px;height:30px;border-radius:50%;background:#3498db;color:white;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;font-size:18px;transition:background 0.3s;}.zoom-btn:hover{background:#2980b9;}.zoom-btn.reset{background:#e74c3c;}.zoom-btn.reset:hover{background:#c0392b;}.history-range{display:flex;gap:10px;margin-bottom:15px;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;}.history-btn{padding:8px 15px;border-radius:20px;background:rgba(255,255,255,0.1);cursor:pointer;transition:all 0.3s;}.history-btn.active{background:rgba(52,152,219,0.3);}.tab-content{display:none;}.tab-content.active{display:block;}.instructions{background:rgba(0,0,0,0.2);border-radius:15px;padding:20px;margin-top:20px;}.instructions h3{color:#3498db;margin-bottom:15px;display:flex;align-items:center;gap:10px;}.instructions ul{padding-left:25px;}.instructions li{margin-bottom:10px;line-height:1.5;}.instructions strong{color:#3498db;}.controls{display:flex;justify-content:center;align-items:center;gap:0.8rem;margin:1.2rem 0;flex-wrap:wrap;}.control-btn{padding:0.6rem 1.2rem;background-color:rgba(0,0,0,0.25);border:2px solid var(--secondary);border-radius:30px;color:var(--secondary);font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:0.5rem;}.control-btn:hover{background-color:var(--secondary);color:white;}.date-display{font-weight:600;color:white;background-color:rgba(0,0,0,0.3);padding:0.5rem 1.2rem;border-radius:30px;min-width:250px;text-align:center;}.tab-btn{padding:0.7rem 1.2rem;background-color:rgba(0,0,0,0.25);border:none;border-radius:30px;cursor:pointer;font-weight:600;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;color:white;}.tab-btn.active{background-color:var(--secondary);color:white;}.tab-btn:hover:not(.active){background-color:rgba(255,255,255,0.15);}.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;margin-top:1.5rem;}.stat-card-monitor{background:linear-gradient(135deg,var(--secondary),var(--primary));color:white;padding:1rem;border-radius:8px;text-align:center;transition:transform 0.3s ease;}.stat-card-monitor:hover{transform:scale(1.03);}.stat-card-monitor .value{font-size:1.8rem;font-weight:700;margin:0.5rem 0;}.stat-card-monitor .label{font-size:0.9rem;opacity:0.9;display:flex;align-items:center;justify-content:center;gap:5px;}.stat-card-monitor i{font-size:1.2rem;}.correction-info{background:rgba(0,0,0,0.25);border-radius:12px;padding:15px;margin-top:15px;text-align:center;}.correction-value{font-size:1.5rem;font-weight:bold;color:#f39c12;}.correction-controls{display:flex;gap:10px;margin-top:10px;}.correction-input{flex:1;background:rgba(0,0,0,0.2);border:1px solid #f39c12;border-radius:8px;padding:8px;color:white;text-align:center;font-size:1.1rem;}.correction-btn{padding:8px 15px;border-radius:8px;background:#f39c12;color:white;border:none;cursor:pointer;font-weight:bold;transition:all 0.3s;}.correction-btn:hover{background:#e67e22;}.reset-stats-btn{background:#9b59b6;margin-top:15px;}.reset-stats-btn:hover{background:#8e44ad;}/* MQTT Configuration Panel */.mqtt-config{background:rgba(0,0,0,0.25);border-radius:15px;padding:20px;margin-bottom:20px;}.mqtt-config h3{color:#3498db;margin-bottom:15px;display:flex;align-items:center;gap:10px;}.mqtt-form{display:grid;grid-template-columns:1fr 1fr;gap:15px;}.mqtt-field{margin-bottom:15px;}.mqtt-field label{display:block;margin-bottom:5px;color:#3498db;font-weight:bold;}.mqtt-field input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(0,0,0,0.2);color:white;}.mqtt-actions{display:flex;gap:10px;margin-top:10px;grid-column:span 2;}.mqtt-status{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:rgba(0,0,0,0.3);margin-top:15px;}.mqtt-indicator{width:12px;height:12px;border-radius:50%;background-color:var(--mqtt-disconnected);}.mqtt-indicator.connected{background-color:var(--mqtt-connected);box-shadow:0 0 8px var(--mqtt-connected);}.mqtt-topic-list{margin-top:20px;background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;}.topic-item{padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);font-family:monospace;display:flex;justify-content:space-between;}.topic-item:last-child{border-bottom:none;}.mqtt-log{background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;margin-top:15px;height:150px;overflow-y:auto;}.mqtt-log-entry{font-family:monospace;font-size:0.9rem;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.1);}.mqtt-log-entry:last-child{border-bottom:none;}.mqtt-log-topic{color:#3498db;font-weight:bold;}.mqtt-log-message{color:#f39c12;}
        /* Dodano dla poprawy obsługi dotyku na canvas */
        canvas {
            touch-action: none;
        }

        /* Styles for new blower controls */
        .blower-manual-controls {
            display: none; /* Hidden by default, shown when blowerManualToggle is checked */
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-fire"></i> Symulator Pieca Peletowego z MQTT</h1>
            <div class="subtitle">Sterowanie przez ESP32 z obsługą pełnej historii danych i korektą</div>
            <div class="system-status">
                <div class="status-badge status-good">
                    <i class="fas fa-history"></i>
                    Pełna historia danych
                </div>
                <div class="status-badge status-good">
                    <i class="fas fa-wifi"></i>
                    Sterowanie przez MQTT
                </div>
                <div class="status-badge status-good">
                    <i class="fas fa-microchip"></i>
                    Kompatybilne z ESP32
                </div>
            </div>
        </header>
        
        <!-- MQTT Configuration Panel -->
        <div class="mqtt-config">
            <h3><i class="fas fa-wifi"></i> Konfiguracja połączenia MQTT</h3>
            <div class="mqtt-form">
                <div class="mqtt-field">
                    <label for="mqtt-broker">Adres brokera MQTT</label>
                    <input type="text" id="mqtt-broker" value="broker.emqx.io">
                </div>
                <div class="mqtt-field">
                    <label for="mqtt-port">Port</label>
                    <input type="number" id="mqtt-port" value="8084">
                </div>
                <div class="mqtt-field">
                    <label for="mqtt-username">Nazwa użytkownika</label>
                    <input type="text" id="mqtt-username" value="agentsan007">
                </div>
                <div class="mqtt-field">
                    <label for="mqtt-password">Hasło</label>
                    <input type="password" id="mqtt-password" value="Sanders24*">
                </div>
                <div class="mqtt-actions">
                    <button id="mqtt-connect-btn" class="success">
                        <i class="fas fa-plug"></i> Połącz
                    </button>
                    <button id="mqtt-disconnect-btn" class="danger">
                        <i class="fas fa-plug"></i> Rozłącz
                    </button>
                </div>
            </div>
            
            <div class="mqtt-status">
                <div class="mqtt-indicator connected" id="mqtt-status-indicator"></div>
                <span id="mqtt-status-text">Połączono</span>
            </div>
            
            <div class="mqtt-topic-list">
                <h4><i class="fas fa-list"></i> Aktywne tematy</h4>
                <div class="topic-item">
                    <span>pellet/boiler/state</span>
                    <span>Publikowanie stanu</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/control</span>
                    <span>Odbieranie poleceń</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/target_temp</span>
                    <span>Ustawianie temperatury</span>
                </div>
                <div class="topic-item">
                    <span>pellet/boiler/power</span>
                    <span>Włączanie/wyłączanie</span>
                </div>
            </div>
            
            <div class="mqtt-log">
                <h4><i class="fas fa-terminal"></i> Log komunikacji MQTT</h4>
                <div id="mqtt-log"><div class="mqtt-log-entry"><span class="mqtt-log-time">[05:11:59]</span> <span class="mqtt-log-topic">pellet/boiler/control</span>: <span class="mqtt-log-message">{"command":"power"}</span></div><div class="mqtt-log-entry"><span class="mqtt-log-time">[05:11:55]</span> <span class="mqtt-log-topic">MQTT</span>: <span class="mqtt-log-message">Subskrybowano: pellet/boiler/state</span></div><div class="mqtt-log-entry"><span class="mqtt-log-time">[05:11:54]</span> <span class="mqtt-log-topic">MQTT</span>: <span class="mqtt-log-message">Połączono z brokerem</span></div></div>
            </div>
        </div>
        
        <div class="dashboard">
            <!-- Left column - status and control -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-fire"></i> Sterowanie Piecem</h2>
                
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">
                            <i class="fas fa-temperature-high"></i> Temperatura wody
                            <span class="status-indicator" id="water-status"></span>
                        </div>
                        <div class="status-value" id="water-temp">73.2°C</div>
                        <div class="progress-container">
                            <div class="progress-bar ignition-bar" id="water-progress" style="width: 95.1074%;"></div>
                        </div>
                        <div class="status-label">Cel: <span id="target-temp">77</span>°C</div>
                        
                        <!-- Device status -->
                        <div class="device-status">
                            <div class="status-item">
                                <div class="status-label">
                                    <i class="fas fa-wind"></i> Dmuchawa
                                </div>
                                <span class="status-indicator status-active" id="blower-status-indicator-mini"></span>
                            </div>
                            <div class="status-item">
                                <div class="status-label">
                                    <i class="fas fa-conveyor-belt"></i> Podajnik
                                </div>
                                <span class="status-indicator status-inactive" id="feeder-status-indicator-mini"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-home"></i> Temperatura pokojowa</div>
                        <div class="status-value" id="room-temp">24.0°C</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-fire"></i> Temperatura palnika</div>
                        <div class="status-value" id="burner-temp">63.4°C</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-smoke"></i> Temperatura spalin</div>
                        <div class="status-value" id="exhaust-temp">86.4°C</div>
                    </div>
                </div>
                
                <div class="control-group">
                    <button id="power-btn" class="success"><i class="fas fa-power-off"></i> WŁĄCZONY</button>
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span><i class="fas fa-thermometer-half"></i> Temperatura docelowa:</span>
                        <span id="target-display">77°C</span>
                    </div>
                    <input type="range" id="target-slider" min="40" max="85" value="70">
                </div>
                
                <!-- Advanced feeder control -->
                <div class="slider-container">
                    <div class="control-header">
                        <i class="fas fa-conveyor-belt" style="color: var(--feeder-color);"></i>
                        <span>Zaawansowane sterowanie podajnikiem</span>
                    </div>
                    
                    <div class="time-control">
                        <div class="time-input">
                            <label for="feed-time">Czas podawania (s)</label>
                            <input type="number" id="feed-time" min="1" value="5">
                        </div>
                        
                        <div class="time-input">
                            <label for="pause-time">Czas przerwy (s)</label>
                            <input type="number" id="pause-time" min="1" value="30">
                        </div>
                    </div>
                    
                    <div class="feeder-cycle">
                        <div class="cycle-status off" id="feeder-status"><span class="status-indicator status-inactive"></span> PODAJNIK: PRZERWA</div>
                        <div class="cycle-progress">
                            <div class="cycle-progress-bar" id="cycle-progress-bar" style="width: 8.33333%; background: var(--feeder-pause-color);"></div>
                        </div>
                        <div class="status-label">Pozostało: <span id="cycle-timer">55s do końca</span></div>
                    </div>
                    
                    <div class="status-label">Średnia ilość peletu: <span id="pellet-amount">0.10</span> kg/h</div>
                </div>
                
                <!-- Flame maintenance mode -->
                <div class="slider-container">
                    <div class="control-header">
                        <i class="fas fa-fire-alt" style="color: var(--maintenance-color);"></i>
                        <span>Tryb podtrzymania płomienia</span>
                    </div>
                    
                    <div class="time-control">
                        <div class="time-input">
                            <label for="maintenance-feed">Podawanie (s)</label>
                            <input type="number" id="maintenance-feed" min="1" max="10" value="2">
                        </div>
                        
                        <div class="time-input">
                            <label for="maintenance-pause">Przerwa (s)</label>
                            <input type="number" id="maintenance-pause" min="10" max="14400" value="60">
                        </div>
                    </div>
                    
                    <div class="auto-clean">
                        <div class="auto-clean-label">
                            <i class="fas fa-fire-alt"></i>
                            <span>Status trybu podtrzymania:</span>
                        </div>
                        <div class="maintenance-indicator maintenance-active" id="maintenance-status">AKTYWNY</div>
                    </div>
                    <div class="status-label">Pozostało do czyszczenia: <span id="clean-timer">23:55:00</span></div>
                </div>
                
                <!-- Blower control -->
                <div class="slider-container">
                    <div class="control-header">
                        <i class="fas fa-wind" style="color: var(--blower-color);"></i>
                        <span>Sterowanie Dmuchawą</span>
                    </div>
                    <div class="auto-clean">
                        <span>Sterowanie manualne dmuchawą:</span>
                        <label class="switch">
                            <input type="checkbox" id="blower-manual-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <!-- NOWE: Sekcja dla ręcznego ustawiania mocy dmuchawy w fazach -->
                    <div class="blower-manual-controls" id="blower-manual-controls" style="display: none;">
                        <div class="slider-label">
                            <span>Moc dmuchawy (praca) (%):</span>
                            <span id="blower-work-power-display">70%</span>
                        </div>
                        <input type="range" id="blower-work-power-slider" min="0" max="100" value="70">

                        <div class="slider-label" style="margin-top: 20px;">
                            <span>Moc dmuchawy (podtrzymanie) (%):</span> <!-- NOWE -->
                            <span id="blower-maintenance-manual-power-display">30%</span> <!-- NOWE -->
                        </div>
                        <input type="range" id="blower-maintenance-manual-power-slider" min="0" max="100" value="30"> <!-- NOWE -->

                        <div class="slider-label" style="margin-top: 20px;">
                            <span>Moc dmuchawy (przedmuch) (%):</span>
                            <span id="blower-purge-manual-power-display">50%</span>
                        </div>
                        <input type="range" id="blower-purge-manual-power-slider" min="0" max="100" value="50">
                    </div>

                    <div class="slider-label" style="margin-top: 20px;">
                        <span>Aktualna moc dmuchawy (%):</span>
                        <span id="blower-power-display">20%</span>
                    </div>
                    <input type="range" id="blower-power-slider" min="0" max="100" value="50" disabled=""> <!-- Ten suwak jest tylko do wyświetlania -->


                    <!-- Tryb przedmuchu dmuchawy -->
                    <div class="auto-clean" style="margin-top: 20px;">
                        <span>Tryb przedmuchu dmuchawy:</span>
                        <label class="switch">
                            <input type="checkbox" id="blower-purge-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="time-control" id="blower-purge-times" style="display: none;">
                        <div class="time-input">
                            <label for="blower-purge-on">Przedmuch ON (s)</label>
                            <input type="number" id="blower-purge-on" min="1" max="60" value="5">
                        </div>
                        <div class="time-input">
                            <label for="blower-purge-off">Przedmuch OFF (s)</label>
                            <input type="number" id="blower-purge-off" min="10" max="3600" value="300">
                        </div>
                    </div>
                </div>

                <div class="ignition-container card">
                    <h3 class="card-title"><i class="fas fa-fire-alt"></i> Zapłon i Płomień</h3>
                    <div class="flame-indicator on" id="flame-indicator">
                        <i class="fas fa-fire"></i>
                        <div class="igniter-indicator ready" id="igniter-indicator" style="display: none;">
                            <i class="fas fa-bolt"></i>
                        </div>
                    </div>
                    <div class="ignition-status off" id="igniter-status-text">off</div>
                    <div class="temperature-display" id="igniter-temp-display">20.0°C</div>
                </div>
                
                <div class="auto-clean">
                    <div class="auto-clean-label">
                        <i class="fas fa-broom"></i>
                        <span>Automatyczne czyszczenie:</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="auto-clean-toggle" checked="">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button id="ash-btn" class="warning">
                    <i class="fas fa-eraser"></i> WYMUSZONE CZYSZCZENIE
                </button>

                <div class="edit-clean-container">
                    <div class="edit-clean-header">
                        <i class="fas fa-clock"></i> Edytuj Czas Czyszczenia
                    </div>
                    <div class="edit-clean-fields">
                        <div class="edit-time-input">
                            <label for="clean-hours">Godziny</label>
                            <input type="number" id="clean-hours" min="0" max="23" value="3">
                        </div>
                        <div class="edit-time-input">
                            <label for="clean-minutes">Minuty</label>
                            <input type="number" id="clean-minutes" min="0" max="59" value="0">
                        </div>
                        <div class="edit-time-input">
                            <label for="clean-seconds">Sekundy</label>
                            <input type="number" id="clean-seconds" min="0" max="59" value="0">
                        </div>
                        <button id="update-clean-btn" class="success"><i class="fas fa-save"></i> Zapisz</button>
                    </div>
                    <div class="status-label" style="margin-top: 15px;">
                        <i class="fas fa-hourglass-half"></i> Czas do czyszczenia: <span id="clean-countdown-display">02:21:55</span>
                    </div>
                </div>
            </div>
            
            <!-- Right column - monitoring and charts -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> Monitoring Systemu</h2>
                
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-clock"></i> Czas pracy sesji</div>
                        <div class="status-value" id="session-uptime">00:41:17</div>
                        <button id="reset-session-uptime-btn" class="reset-stats-btn"><i class="fas fa-redo"></i> Resetuj sesję</button>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-clock"></i> Całkowity czas pracy</div>
                        <div class="status-value" id="total-uptime">03:38:06</div>
                    </div>

                    <!-- NOWE: Średnie zużycie opału -->
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-chart-bar"></i> Średnie zużycie (ostatnia godzina)</div>
                        <div class="status-value" id="average-pellet-consumption">0.19kg/h</div>
                    </div>

                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-wifi"></i> Siła sygnału</div>
                        <div class="status-value" id="rssi">-59dBm</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-network-wired"></i> Adres IP</div>
                        <div class="status-value" id="ip-addr">192.168.3.107</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label"><i class="fas fa-cloud"></i> Status MQTT</div>
                        <div class="status-value" id="mqtt-status-text">Brak</div>
                        <div class="mqtt-indicator" id="mqtt-status-indicator"></div>
                    </div>
                </div>

                <div class="system-status">
                    <div class="status-badge status-good" id="maintenance-status-badge">
                        <i class="fas fa-wrench"></i> Tryb podtrzymania: <span id="maintenance-status">NIE</span>
                    </div>
                    <div class="status-badge status-good" id="cleaning-status-badge">
                        <i class="fas fa-brush"></i> Czyszczenie: <span id="ash-cleaning-status">NIE</span>
                    </div>
                </div>

                <!-- NOWE: Przyciski do włączania/wyłączania poszczególnych linii wykresu temperatury -->
                <div class="chart-controls" id="temperature-chart-toggles" style="display: flex;"> 
                    <div class="dataset-toggle active" data-chart="water_temp">
                        <span class="chart-color-indicator" style="background-color: #3498db;"></span> Woda
                    </div>
                    <div class="dataset-toggle active" data-chart="room_temp">
                        <span class="chart-color-indicator" style="background-color: #2ecc71;"></span> Pokój
                    </div>
                    <div class="dataset-toggle active" data-chart="burner_temp">
                        <span class="chart-color-indicator" style="background-color: #e74c3c;"></span> Palnik
                    </div>
                    <div class="dataset-toggle active" data-chart="exhaust_temp">
                        <span class="chart-color-indicator" style="background-color: #f39c12;"></span> Spaliny
                    </div>
                </div>

                <div class="chart-container" id="chart-container-temp">
                    <div class="zoom-controls">
                        <div class="zoom-btn" id="zoom-in">+</div>
                        <div class="zoom-btn" id="zoom-out">-</div>
                        <div class="zoom-btn reset" id="zoom-reset">Reset</div>
                    </div>
                    <canvas id="temperature-chart" width="611" height="270" style="display: block; box-sizing: border-box; height: 270px; width: 611px;"></canvas>
                </div>

                <div class="chart-container" id="chart-container-consumption" style="display: none;">
                    <div class="zoom-controls">
                        <div class="zoom-btn" id="consumption-zoom-in">+</div>
                        <div class="zoom-btn" id="consumption-zoom-out">-</div>
                        <div class="zoom-btn reset" id="consumption-zoom-reset">Reset</div>
                    </div>
                    <canvas id="consumption-chart" height="0" style="display: block; box-sizing: border-box; height: 0px; width: 0px;" width="0"></canvas>
                </div>

                <!-- Nowe kontenery dla wykresów słupkowych -->
                <div class="chart-container" id="chart-container-daily-consumption" style="display: none;">
                    <canvas id="daily-consumption-chart" height="0" style="display: block; box-sizing: border-box; height: 0px; width: 0px;" width="0"></canvas>
                </div>
                <div class="chart-container" id="chart-container-monthly-consumption" style="display: none;">
                    <canvas id="monthly-consumption-chart" height="0" style="display: block; box-sizing: border-box; height: 0px; width: 0px;" width="0"></canvas>
                </div>
                <div class="chart-container" id="chart-container-yearly-consumption" style="display: none;">
                    <canvas id="yearly-consumption-chart" height="0" style="display: block; box-sizing: border-box; height: 0px; width: 0px;" width="0"></canvas>
                </div>
                <div class="chart-container" id="chart-container-global-consumption" style="display: none;">
                    <canvas id="global-consumption-chart" height="0" style="display: block; box-sizing: border-box; height: 0px; width: 0px;" width="0"></canvas>
                </div>


                <div class="chart-switcher" id="main-chart-switcher">
                    <div class="chart-switch active" data-chart-type="temperature">
                        <span class="chart-color-indicator" style="background-color: #3498db;"></span> Temperatury
                    </div>
                    <div class="chart-switch" data-chart-type="consumption">
                        <span class="chart-color-indicator" style="background-color: #d35400;"></span> Zużycie Opału (Linia)
                    </div>
                    <div class="chart-switch" data-chart-type="daily-consumption">
                        <span class="chart-color-indicator" style="background-color: #d35400;"></span> Zużycie Dzienne
                    </div>
                    <div class="chart-switch" data-chart-type="monthly-consumption">
                        <span class="chart-color-indicator" style="background-color: #d35400;"></span> Zużycie Miesięczne
                    </div>
                    <div class="chart-switch" data-chart-type="yearly-consumption">
                        <span class="chart-color-indicator" style="background-color: #d35400;"></span> Zużycie Roczne
                    </div>
                    <div class="chart-switch" data-chart-type="global-consumption">
                        <span class="chart-color-indicator" style="background-color: #d35400;"></span> Zużycie Globalne
                    </div>
                </div>

                <div class="history-range">
                    <div class="history-btn active" data-range="1h">1h</div>
                    <div class="history-btn" data-range="6h">6h</div>
                    <div class="history-btn" data-range="24h">24h</div>
                    <div class="history-btn" data-range="7d">7d</div>
                </div>

                <div class="history-stats">
                    <div class="history-card">
                        <div class="history-title"><i class="fas fa-fire"></i> Godziny pracy palnika</div>
                        <div class="history-value" id="burner-hours">00:00</div>
                    </div>
                    <div class="history-card">
                        <div class="history-title"><i class="fas fa-dollar-sign"></i> Szacowany koszt</div>
                        <div class="history-value" id="estimated-cost">0.00 PLN</div>
                    </div>
                </div>

                <div class="cost-calculation">
                    <h3 class="card-title"><i class="fas fa-calculator"></i> Kalkulacja Kosztów</h3>
                    <div class="cost-row">
                        <span>Cena peletu (PLN/kg):</span>
                        <input type="number" id="pellet-price" value="1.2" step="0.01">
                    </div>
                    <div class="cost-row">
                        <span>Zużycie (kg/h):</span>
                        <input type="number" id="pellet-consumption" value="1.5" step="0.1" disabled=""> <!-- Disabled as it's now calculated -->
                    </div>
                    <div class="cost-row cost-total">
                        <span>Całkowity koszt:</span>
                        <span id="total-calculated-cost">0.00 PLN</span>
                    </div>
                </div>

                <div class="efficiency-gauge">
                    <div class="gauge-fill" id="efficiency-fill" style="width: 86%;"></div>
                    <span class="gauge-label" id="efficiency-label">86% Wydajność</span>
                </div>

                <!-- Sekcja resetowania danych historycznych -->
                <div class="slider-container" style="margin-top: 20px;">
                    <div class="control-header">
                        <i class="fas fa-history" style="color: var(--warning);"></i>
                        <span>Resetuj Dane Historyczne i Całkowity Czas Pracy</span>
                    </div>
                    <div class="time-input" style="margin-bottom: 15px;">
                        <label for="reset-password">Hasło (MQTT)</label>
                        <input type="password" id="reset-password" placeholder="Wprowadź hasło MQTT">
                    </div>
                    <button id="reset-history-btn" class="danger">
                        <i class="fas fa-trash-alt"></i> RESETUJ DANE
                    </button>
                    <div id="reset-message" style="margin-top: 10px; text-align: center; font-weight: bold;"></div>
                </div>
            </div>
        </div>

        <div class="instructions card">
            <h3><i class="fas fa-info-circle"></i> Instrukcje Użycia</h3>
            <ul>
                <li><i class="fas fa-check-circle"></i> Podłącz ESP32 do zasilania i upewnij się, że jest połączony z siecią Wi-Fi.</li>
                <li><i class="fas fa-check-circle"></i> Otwórz przeglądarkę i przejdź do adresu IP wyświetlonego w monitorze szeregowym.</li>
                <li><i class="fas fa-check-circle"></i> Użyj przycisku "WŁĄCZONY/WYŁĄCZONY", aby sterować piecem.</li>
                <li><i class="fas fa-check-circle"></i> Przesuń suwak "Temperatura docelowa", aby ustawić żądaną temperaturę wody.</li>
                <li><i class="fas fa-check-circle"></i> Monitoruj temperatury, status płomienia, podajnika i dmuchawy.</li>
                <li><i class="fas fa-check-circle"></i> Sekcja "Monitoring Systemu" pokazuje dane takie jak czas pracy, siła sygnału Wi-Fi i status MQTT (połączenia ESP32).</li>
                <li><i class="fas fa-check-circle"></i> Wykresy temperatur pozwalają na wizualizację danych historycznych.</li>
            </ul>
        </div>
    </div>
    
    <script>
        // Globalne zmienne dla klienta MQTT i tematów
        let client = null; 
        let isMqttConnected = false;

        // Tematy MQTT - zgodne z tymi w kodzie ESP32
        const MQTT_TOPICS = {
            state: "pellet/boiler/state",
            control: "pellet/boiler/control", // Dla komend JSON (np. {"command":"power"})
            targetTemp: "pellet/boiler/target_temp", // Dla temperatury docelowej
            power: "pellet/boiler/power" // Dla prostych komend ON/OFF
        };

        // --- Elementy DOM (wybrane kluczowe) ---
        const mqttBrokerInput = document.getElementById('mqtt-broker');
        const mqttPortInput = document.getElementById('mqtt-port');
        const mqttUsernameInput = document.getElementById('mqtt-username');
        const mqttPasswordInput = document.getElementById('mqtt-password');
        const mqttConnectBtn = document.getElementById('mqtt-connect-btn');
        const mqttDisconnectBtn = document.getElementById('mqtt-disconnect-btn');
        const mqttStatusIndicator = document.getElementById('mqtt-status-indicator');
        const mqttStatusText = document.getElementById('mqtt-status-text');
        const mqttLogDiv = document.getElementById('mqtt-log');

        const powerBtn = document.getElementById('power-btn');
        const targetSlider = document.getElementById('target-slider');
        const targetDisplay = document.getElementById('target-display'); // Wartość suwaka
        const targetTemp = document.getElementById('target-temp'); // Cel na głównym panelu

        const waterTempDisplay = document.getElementById('water-temp');
        const roomTempDisplay = document.getElementById('room-temp');
        const burnerTempDisplay = document.getElementById('burner-temp');
        const exhaustTempDisplay = document.getElementById('exhaust-temp');
        const waterProgressBar = document.getElementById('water-progress');
        const flameIndicator = document.getElementById('flame-indicator');
        
        // Elementy dla aktualizacji stanu z ESP32
        const feederStatusIndicatorMini = document.getElementById('feeder-status-indicator-mini');
        const blowerStatusIndicatorMini = document.getElementById('blower-status-indicator-mini');
        const maintenanceStatus = document.getElementById('maintenance-status');
        const maintenanceStatusBadge = document.getElementById('maintenance-status-badge');
        const ashCleaningStatus = document.getElementById('ash-cleaning-status');
        const cleaningStatusBadge = document.getElementById('cleaning-status-badge');
        const igniterIndicator = document.getElementById('igniter-indicator');
        const igniterStatusText = document.getElementById('igniter-status-text');
        const igniterTempDisplay = document.getElementById('igniter-temp-display');
        const feederStatus = document.getElementById('feeder-status'); // Dla tekstu "PODAJNIK: PRZERWA"
        const cycleProgressBar = document.getElementById('cycle-progress-bar');
        const cycleTimer = document.getElementById('cycle-timer');
        const pelletAmount = document.getElementById('pellet-amount'); // Średnia ilość peletu na panelu podajnika
        const averagePelletConsumptionDisplay = document.getElementById('average-pellet-consumption'); // Średnie zużycie w monitoring

        const blowerManualControlsDiv = document.getElementById('blower-manual-controls');
        const blowerManualToggle = document.getElementById('blower-manual-toggle');
        const blowerWorkPowerSlider = document.getElementById('blower-work-power-slider');
        const blowerWorkPowerDisplay = document.getElementById('blower-work-power-display');
        const blowerMaintenanceManualPowerSlider = document.getElementById('blower-maintenance-manual-power-slider');
        const blowerMaintenanceManualPowerDisplay = document.getElementById('blower-maintenance-manual-power-display');
        const blowerPurgeManualPowerSlider = document.getElementById('blower-purge-manual-power-slider');
        const blowerPurgeManualPowerDisplay = document.getElementById('blower-purge-manual-power-display');
        const blowerPowerSlider = document.getElementById('blower-power-slider'); // Aktualna moc dmuchawy (wyświetlanie)
        const blowerPowerDisplay = document.getElementById('blower-power-display'); // Aktualna moc dmuchawy (wyświetlanie)
        const blowerPurgeToggle = document.getElementById('blower-purge-toggle');
        const blowerPurgeTimesContainer = document.getElementById('blower-purge-times');
        const blowerPurgeOnInput = document.getElementById('blower-purge-on');
        const blowerPurgeOffInput = document.getElementById('blower-purge-off');


        const sessionUptimeDisplay = document.getElementById('session-uptime');
        const totalUptimeDisplay = document.getElementById('total-uptime');
        const rssi = document.getElementById('rssi');
        const ipAddr = document.getElementById('ip-addr');

        const burnerHoursDisplay = document.getElementById('burner-hours'); // Godziny pracy palnika
        const estimatedCostDisplay = document.getElementById('estimated-cost'); // Szacowany koszt (w historii)
        const pelletPriceInput = document.getElementById('pellet-price');
        const pelletConsumptionInput = document.getElementById('pellet-consumption');
        const totalCalculatedCost = document.getElementById('total-calculated-cost'); // Całkowity koszt (w kalkulacji)
        const efficiencyFill = document.getElementById('efficiency-fill');
        const efficiencyLabel = document.getElementById('efficiency-label');

        const cleanHoursInput = document.getElementById('clean-hours');
        const cleanMinutesInput = document.getElementById('clean-minutes');
        const cleanSecondsInput = document.getElementById('clean-seconds');
        const updateCleanBtn = document.getElementById('update-clean-btn');
        const cleanCountdownDisplay = document.getElementById('clean-countdown-display');

        const ashBtn = document.getElementById('ash-btn');
        const resetSessionUptimeBtn = document.getElementById('reset-session-uptime-btn');
        const resetHistoryBtn = document.getElementById('reset-history-btn');
        const resetPasswordInput = document.getElementById('reset-password');
        const resetMessageDiv = document.getElementById('reset-message');
        
        // Elementy dla wykresów
        const temperatureChartToggles = document.getElementById('temperature-chart-toggles');
        const mainChartSwitcher = document.getElementById('main-chart-switcher');
        const chartContainerTemp = document.getElementById('chart-container-temp');
        const chartContainerConsumption = document.getElementById('chart-container-consumption');
        const chartContainerDailyConsumption = document.getElementById('chart-container-daily-consumption');
        const chartContainerMonthlyConsumption = document.getElementById('monthly-consumption-chart');
        const chartContainerYearlyConsumption = document.getElementById('chart-container-yearly-consumption');
        const chartContainerGlobalConsumption = document.getElementById('global-consumption-chart');
        const historyRangeButtons = document.querySelectorAll('.history-btn');


        // Chart.js setup - Zmieniono nazwy zmiennych, aby nie kolidowały z nazwami funkcji
        let temperatureChartInstance;
        let consumptionChartInstance;
        let dailyConsumptionChartInstance;
        let monthlyConsumptionChartInstance;
        let yearlyConsumptionChartInstance;
        let globalConsumptionChartInstance;

        const chartData = {
            water_temp: [],
            room_temp: [],
            burner_temp: [],
            exhaust_temp: [],
            pellet_consumption: []
        };
        const chartDatasetMap = {
            'water_temp': 0,
            'room_temp': 1,
            'burner_temp': 2,
            'exhaust_temp': 3
        };

        // --- Funkcje pomocnicze dla UI i MQTT ---

        function appendMqttLog(topic, message) {
            const now = new Date();
            const time = now.toTimeString().split(' ')[0].substring(0, 8);
            const logEntry = document.createElement('div');
            logEntry.classList.add('mqtt-log-entry');
            logEntry.innerHTML = `<span class="mqtt-log-time">[${time}]</span> <span class="mqtt-log-topic">${topic}</span>: <span class="mqtt-log-message">${message}</span>`;
            mqttLogDiv.prepend(logEntry); // Dodaj na początek
            // Ogranicz liczbę logów, aby nie zaśmiecać pamięci przeglądarki
            while (mqttLogDiv.children.length > 50) {
                mqttLogDiv.removeChild(mqttLogDiv.lastChild);
            }
        }

        function updateMqttStatus(connected) {
            isMqttConnected = connected;
            if (connected) {
                mqttStatusIndicator.classList.remove('disconnected');
                mqttStatusIndicator.classList.add('connected');
                mqttStatusText.textContent = "Połączono";
                // Upewnij się, że ten log nie powoduje pętli, jeśli jest wywoływany w on('connect')
                appendMqttLog("MQTT", "Połączono z brokerem"); 
            } else {
                mqttStatusIndicator.classList.remove('connected');
                mqttStatusIndicator.classList.add('disconnected');
                mqttStatusText.textContent = "Rozłączono";
                appendMqttLog("MQTT", "Rozłączono z brokerem");
            }
            // Zablokuj/odblokuj przyciski i suwak w zależności od statusu połączenia MQTT
            mqttConnectBtn.disabled = connected;
            mqttDisconnectBtn.disabled = !connected;
            powerBtn.disabled = !connected;
            targetSlider.disabled = !connected;
        }

        function connectMQTT() {
            if (client && client.connected) {
                appendMqttLog("MQTT", "Już połączono z brokerem.");
                return;
            }

            const broker = mqttBrokerInput.value;
            const port = mqttPortInput.value; 
            const username = mqttUsernameInput.value;
            const password = mqttPasswordInput.value;

            // Zmieniono: Użycie protokołu WebSocket (wss://) dla połączeń z przeglądarki hostowanej na GitHubie
            // Port 8084 jest typowy dla WSS w brokerze EMQX.
            const mqttUrl = `wss://${broker}:${port}/mqtt`; 
            
            appendMqttLog("MQTT", `Próba połączenia z brokerem: ${mqttUrl}`);

            client = mqtt.connect(mqttUrl, {
                clientId: 'web_client_' + Math.random().toString(16).substr(2, 8),
                username: username,
                password: password,
                clean: true,
                keepalive: 60 // Sekundy, częstotliwość wysyłania pakietów keepalive
            });

            client.on('connect', () => {
                updateMqttStatus(true);
                // Subskrybuj tematy, na których ESP32 publikuje stan
                client.subscribe(MQTT_TOPICS.state, (err) => {
                    if (!err) {
                        appendMqttLog("MQTT", `Subskrybowano: ${MQTT_TOPICS.state}`);
                    } else {
                        appendMqttLog("MQTT ERROR", `Błąd subskrypcji ${MQTT_TOPICS.state}: ${err.message}`);
                    }
                });
            });

            client.on('message', (topic, message) => {
                const msgString = message.toString();
                appendMqttLog(topic, msgString);
                
                if (topic === MQTT_TOPICS.state) {
                    try {
                        const data = JSON.parse(msgString);
                        updateUI(data);
                    } catch (e) {
                        appendMqttLog("JSON PARSE ERROR", `Nie udało się sparsować wiadomości: ${e.message}`);
                        console.error('MQTT: Failed to parse MQTT message:', e);
                    }
                }
            });

            client.on('error', (err) => {
                appendMqttLog("MQTT ERROR", `Błąd połączenia: ${err.message}`);
                console.error('MQTT: An error occurred:', err);
                updateMqttStatus(false);
                if (client) {
                    client.end();
                    client = null;
                }
            });

            client.on('close', () => {
                updateMqttStatus(false);
                appendMqttLog("MQTT", "Połączenie zamknięte.");
                client = null;
            });

            client.on('offline', () => {
                appendMqttLog("MQTT", "Klient offline.");
                updateMqttStatus(false);
            });

            client.on('reconnect', () => {
                appendMqttLog("MQTT", "Próba ponownego połączenia...");
                mqttStatusText.textContent = 'Łączenie...';
                mqttStatusIndicator.classList.remove('connected');
                mqttStatusIndicator.classList.add('disconnected');
            });
        }

        function disconnectMQTT() {
            if (client) {
                client.end();
            } else {
                appendMqttLog("MQTT", "Klient nie jest połączony, nie ma potrzeby rozłączania.");
            }
        }

        // Funkcja do publikowania wiadomości MQTT
        function publishMqttMessage(topic, message) {
            if (isMqttConnected && client) {
                client.publish(topic, message.toString(), {}, (err) => { // Zawsze wysyłaj jako string
                    if (err) {
                        appendMqttLog("PUBLISH ERROR", `Błąd publikacji na ${topic}: ${err.message}`);
                    } else {
                        appendMqttLog(topic, message.toString(), 'sent');
                    }
                });
            } else {
                appendMqttLog("MQTT ERROR", "Nie połączono z brokerem MQTT! Wiadomość nie wysłana.");
                console.warn("MQTT client not connected. Message not sent.");
            }
        }
        
        // Helper function to format seconds into HH:MM:SS
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Function to calculate average pellet consumption for a given duration
        function calculateAverageConsumption(durationMinutes = 60) {
            if (chartData.pellet_consumption.length === 0) {
                return 0.0;
            }

            const now = luxon.DateTime.now();
            const cutoffTime = now.minus({ minutes: durationMinutes }).toMillis();

            const recentData = chartData.pellet_consumption.filter(point => point.x >= cutoffTime);

            if (recentData.length === 0) {
                return 0.0;
            }

            const totalConsumptionRate = recentData.reduce((sum, point) => sum + point.y, 0);
            return totalConsumptionRate / recentData.length;
        }

        // Functions to aggregate data for bar charts
        function aggregateDailyConsumption(history) {
            const dailyData = new Map(); // Map<YYYY-MM-DD, total_consumption_kg>
            const now = luxon.DateTime.now();

            history.forEach(point => {
                const dateTime = luxon.DateTime.fromMillis(point.x);
                const dateKey = dateTime.toFormat('yyyy-MM-dd');
                const consumptionKg = point.y / 60; // Convert kg/h to kg per minute interval

                if (dailyData.has(dateKey)) {
                    dailyData.set(dateKey, dailyData.get(dateKey) + consumptionKg);
                } else {
                    dailyData.set(dateKey, consumptionKg);
                }
            });

            // Get last 7 days
            const labels = [];
            const data = [];
            for (let i = 6; i >= 0; i--) { // From 6 days ago to today
                const date = now.minus({ days: i });
                const dateKey = date.toFormat('yyyy-MM-dd');
                labels.push(date.toFormat('EEE dd.MM')); // e.g., Pn 15.07
                data.push(dailyData.has(dateKey) ? dailyData.get(dateKey) : 0);
            }
            return { labels, data };
        }

        function aggregateMonthlyConsumption(history) {
            const monthlyData = new Map(); // Map<YYYY-MM-DD, total_consumption_kg> for last 30 days
            const now = luxon.DateTime.now();

            history.forEach(point => {
                const dateTime = luxon.DateTime.fromMillis(point.x);
                const dateKey = dateTime.toFormat('yyyy-MM-dd');
                const consumptionKg = point.y / 60;

                if (monthlyData.has(dateKey)) {
                    monthlyData.set(dateKey, monthlyData.get(dateKey) + consumptionKg);
                } else {
                    monthlyData.set(dateKey, consumptionKg);
                }
            });

            // Get last 30 days
            const labels = [];
            const data = [];
            for (let i = 29; i >= 0; i--) { // From 29 days ago to today
                const date = now.minus({ days: i });
                const dateKey = date.toFormat('dd.MM'); // e.g., 15.07
                labels.push(dateKey); 
                data.push(monthlyData.has(dateKey) ? monthlyData.get(dateKey) : 0);
            }
            return { labels, data };
        }

        function aggregateYearlyConsumption(history) {
            const yearlyData = new Map(); // Map<YYYY-MM, total_consumption_kg>
            const now = luxon.DateTime.now();

            history.forEach(point => {
                const dateTime = luxon.DateTime.fromMillis(point.x);
                const monthKey = dateTime.toFormat('yyyy-MM');
                const consumptionKg = point.y / 60;

                if (yearlyData.has(monthKey)) {
                    yearlyData.set(monthKey, yearlyData.get(monthKey) + consumptionKg);
                } else {
                    yearlyData.set(monthKey, consumptionKg);
                }
            });

            // Get last 12 months
            const labels = [];
            const data = [];
            for (let i = 11; i >= 0; i--) { // From 11 months ago to current month
                const month = now.minus({ months: i }).startOf('month');
                const monthKey = month.toFormat('yyyy-MM');
                labels.push(month.toFormat('MMM yyyy')); // e.g., Lip 2025
                data.push(yearlyData.has(monthKey) ? yearlyData.get(monthKey) : 0);
            }
            return { labels, data };
        }

        function aggregateGlobalConsumption(history) {
            const globalData = new Map(); // Map<YYYY, total_consumption_kg>

            history.forEach(point => {
                const dateTime = luxon.DateTime.fromMillis(point.x);
                const yearKey = dateTime.toFormat('yyyy');
                const consumptionKg = point.y / 60;

                if (globalData.has(yearKey)) {
                    globalData.set(yearKey, globalData.get(yearKey) + consumptionKg);
                } else {
                    globalData.set(yearKey, consumptionKg);
                }
            });

            // Sort years and prepare labels/data
            const sortedYears = Array.from(globalData.keys()).sort();
            const labels = sortedYears;
            const data = sortedYears.map(year => globalData.get(year));

            return { labels, data };
        }


        // Chart.js initialization
        function initChart(initialHistory = []) {
            const ctxTemp = document.getElementById('temperature-chart').getContext('2d');
            const ctxCons = document.getElementById('consumption-chart').getContext('2d');
            const ctxDailyCons = document.getElementById('daily-consumption-chart').getContext('2d');
            const ctxMonthlyCons = document.getElementById('monthly-consumption-chart').getContext('2d');
            const ctxYearlyCons = document.getElementById('yearly-consumption-chart').getContext('2d');
            const ctxGlobalCons = document.getElementById('global-consumption-chart').getContext('2d');

            for (const key in chartData) {
                chartData[key] = [];
            }

            initialHistory.forEach(point => {
                chartData.water_temp.push({ x: point.timestamp_ms, y: point.water_temp });
                chartData.room_temp.push({ x: point.timestamp_ms, y: point.room_temp });
                chartData.burner_temp.push({ x: point.timestamp_ms, y: point.burner_temp });
                chartData.exhaust_temp.push({ x: point.timestamp_ms, y: point.exhaust_temp });
                chartData.pellet_consumption.push({ x: point.timestamp_ms, y: point.pellet_consumption_rate });
            });

            if (temperatureChartInstance) temperatureChartInstance.destroy();
            if (consumptionChartInstance) consumptionChartInstance.destroy();
            if (dailyConsumptionChartInstance) dailyConsumptionChartInstance.destroy();
            if (monthlyConsumptionChartInstance) monthlyConsumptionChartInstance.destroy();
            if (yearlyConsumptionChartInstance) yearlyConsumptionChartInstance.destroy();
            if (globalConsumptionChartInstance) globalConsumptionChartInstance.destroy();

            temperatureChartInstance = new Chart(ctxTemp, {
                type: 'line',
                data: {
                    labels: chartData.water_temp.map(point => point.x),
                    datasets: [
                        { label: 'Temperatura Wody', data: chartData.water_temp, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.2)', fill: false, tension: 0.3, pointRadius: 0, hidden: false },
                        { label: 'Temperatura Pokojowa', data: chartData.room_temp, borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.2)', fill: false, tension: 0.3, pointRadius: 0, hidden: false },
                        { label: 'Temperatura Palnika', data: chartData.burner_temp, borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.2)', fill: false, tension: 0.3, pointRadius: 0, hidden: false },
                        { label: 'Temperatura Spalin', data: chartData.exhaust_temp, borderColor: '#f39c12', backgroundColor: 'rgba(243, 156, 18, 0.2)', fill: false, tension: 0.3, pointRadius: 0, hidden: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'minute', tooltipFormat: 'yyyy-MM-dd HH:mm:ss', displayFormats: { minute: 'HH:mm', hour: 'HH:mm', day: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }, title: { display: true, text: 'Czas', color: 'white' }, ticks: { color: '#bbb' }, grid: { color: 'rgba(255,255,255,0.1)' } }
,
                        y: { title: { display: true, text: 'Temperatura (°C)', color: 'white' }, ticks: { color: '#bbb' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    },
                    plugins: {
                        legend: { display: false },
                        zoom: { pan: { enabled: true, mode: 'xy', threshold: 10 }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, drag: { enabled: true, borderColor: 'rgba(52, 152, 219, 0.8)', borderWidth: 2, backgroundColor: 'rgba(52, 152, 219, 0.3)' }, mode: 'xy' } },
                        tooltip: { mode: 'index', intersect: false, callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) label += ': '; if (context.parsed.y !== null) label += context.parsed.y.toFixed(1) + '°C'; return label; } } }
                    }
                }
            });

            consumptionChartInstance = new Chart(ctxCons, {
                type: 'line',
                data: {
                    labels: chartData.pellet_consumption.map(point => point.x),
                    datasets: [
                        { label: 'Zużycie Opału (kg/h)', data: chartData.pellet_consumption, borderColor: '#d35400', backgroundColor: 'rgba(211, 84, 0, 0.2)', fill: false, tension: 0.3, pointRadius: 0, hidden: false },
                        { label: 'Średnie Zużycie (ostatnia godzina)', data: [], borderColor: '#ffeb3b', backgroundColor: 'rgba(255, 235, 59, 0.2)', borderDash: [5, 5], fill: false, tension: 0, pointRadius: 0, hidden: false, yAxisID: 'y' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'minute', tooltipFormat: 'yyyy-MM-dd HH:mm:ss', displayFormats: { minute: 'HH:mm', hour: 'HH:mm', day: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }, title: { display: true, text: 'Czas', color: 'white' }, ticks: { color: '#bbb' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { title: { display: true, text: 'Zużycie (kg/h)', color: 'white' }, ticks: { color: '#bbb' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    },
                    plugins: {
                        legend: { display: false },
                        zoom: { pan: { enabled: true, mode: 'xy', threshold: 10 }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, drag: { enabled: true, borderColor: 'rgba(211, 84, 0, 0.8)', borderWidth: 2, backgroundColor: 'rgba(211, 84, 0, 0.3)' }, mode: 'xy' } },
                        tooltip: { mode: 'index', intersect: false, callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) label += ': '; if (context.parsed.y !== null) { if (context.dataset.label === 'Średnie Zużycie (ostatnia godzina)') { const avgConsumptionText = document.getElementById('average-pellet-consumption').textContent; const avgValue = parseFloat(avgConsumptionText); label += avgValue.toFixed(2) + ' kg/h'; } else { label += context.parsed.y.toFixed(2) + ' kg/h'; } } return label; } } }
                    }
                }
            });

            const commonBarChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#bbb' }, title: { display: true, text: 'Okres', color: 'white' } },
                    y: { beginAtZero: true, title: { display: true, text: 'Zużycie (kg)', color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#bbb' } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) label += ': '; if (context.parsed.y !== null) label += context.parsed.y.toFixed(2) + ' kg'; return label; } } }
                }
            };

            dailyConsumptionChartInstance = new Chart(ctxDailyCons, { type: 'bar', data: { labels: [], datasets: [{ label: 'Zużycie Dzienne', data: [], backgroundColor: 'rgba(211, 84, 0, 0.7)', borderColor: '#d35400', borderWidth: 1 }] }, options: commonBarChartOptions });
            monthlyConsumptionChartInstance = new Chart(ctxMonthlyCons, { type: 'bar', data: { labels: [], datasets: [{ label: 'Zużycie Miesięczne', data: [], backgroundColor: 'rgba(211, 84, 0, 0.7)', borderColor: '#d35400', borderWidth: 1 }] }, options: commonBarChartOptions });
            yearlyConsumptionChartInstance = new Chart(ctxYearlyCons, { type: 'bar', data: { labels: [], datasets: [{ label: 'Zużycie Roczne', data: [], backgroundColor: 'rgba(211, 84, 0, 0.7)', borderColor: '#d35400', borderWidth: 1 }] }, options: commonBarChartOptions });
            globalConsumptionChartInstance = new Chart(ctxGlobalCons, { type: 'bar', data: { labels: [], datasets: [{ label: 'Zużycie Globalne', data: [], backgroundColor: 'rgba(211, 84, 0, 0.7)', borderColor: '#d35400', borderWidth: 1 }] }, options: commonBarChartOptions });
        }

        // Add a single new data point to the chart
        function addChartDataPoint(data) {
            const timestamp = data.timestamp_ms; 

            // Temperature Chart Data
            chartData.water_temp.push({ x: timestamp, y: data.water_temp });
            chartData.room_temp.push({ x: timestamp, y: data.room_temp });
            chartData.burner_temp.push({ x: timestamp, y: data.burner_temp });
            chartData.exhaust_temp.push({ x: timestamp, y: data.exhaust_temp });
            
            // Limit history data points for temperature chart
            while (chartData.water_temp.length > 200) { // Keep last 200 points (approx 200 minutes)
                chartData.water_temp.shift();
                chartData.room_temp.shift();
                chartData.burner_temp.shift();
                chartData.exhaust_temp.shift();
            }

            temperatureChartInstance.data.labels = chartData.water_temp.map(point => point.x);
            temperatureChartInstance.data.datasets[chartDatasetMap['water_temp']].data = chartData.water_temp;
            temperatureChartInstance.data.datasets[chartDatasetMap['room_temp']].data = chartData.room_temp;
            temperatureChartInstance.data.datasets[chartDatasetMap['burner_temp']].data = chartData.burner_temp;
            temperatureChartInstance.data.datasets[chartDatasetMap['exhaust_temp']].data = chartData.exhaust_temp;
            temperatureChartInstance.update();

            // Consumption Chart Data
            chartData.pellet_consumption.push({ x: timestamp, y: data.currentPelletConsumptionRate });
            
            // Limit history data points for consumption chart
            while (chartData.pellet_consumption.length > 200) { // Keep last 200 points
                chartData.pellet_consumption.shift();
            }
            consumptionChartInstance.data.labels = chartData.pellet_consumption.map(point => point.x);
            consumptionChartInstance.data.datasets[0].data = chartData.pellet_consumption;
            consumptionChartInstance.update();
        }


        // Update UI based on state
        function updateUI(data) {
            waterTempDisplay.textContent = data.water_temp.toFixed(1) + '°C';
            roomTempDisplay.textContent = data.room_temp.toFixed(1) + '°C';
            burnerTempDisplay.textContent = data.burner_temp.toFixed(1) + '°C';
            exhaustTempDisplay.textContent = data.exhaust_temp.toFixed(1) + '°C';
            targetTemp.textContent = data.target_temp.toFixed(0); // Główny cel
            targetSlider.value = data.target_temp;
            targetDisplay.textContent = data.target_temp.toFixed(0) + '°C'; // Wyświetlacz suwaka
            
            const progress = Math.min(100, (data.water_temp / data.target_temp) * 100);
            waterProgressBar.style.width = progress + '%';
            
            if (data.power === "ON") {
                powerBtn.innerHTML = '<i class="fas fa-power-off"></i> WŁĄCZONY';
                powerBtn.classList.remove('power-off');
                powerBtn.classList.add('success');
            } else {
                powerBtn.innerHTML = '<i class="fas fa-power-off"></i> WYŁĄCZONY';
                powerBtn.classList.remove('success');
                powerBtn.classList.add('power-off');
            }
            
            flameIndicator.className = data.flame ? 'flame-indicator on' : 'flame-indicator off';
            
            // Te elementy UI kontrolują teraz tylko wyświetlanie, wysyłanie komend jest przez MQTT
            // i nie powinny być bezpośrednio aktualizowane przez przychodzące dane, jeśli mają służyć do sterowania
            // autoCleanToggle.checked = data.auto_clean; 
            
            feederStatusIndicatorMini.className = 'status-indicator ' + (data.feeder_active || data.reverseFeederActive ? 'status-active' : 'status-inactive');
            blowerStatusIndicatorMini.className = 'status-indicator ' + (data.blower_active ? 'status-active' : 'status-inactive');

            if (feederStatus && cycleProgressBar && cycleTimer) {
                let feederText = "PAUZA";
                let progressBarColor = 'var(--feeder-pause-color)';
                let totalPhaseDuration = data.currentPhaseDuration;
                let remainingTimeInPhase = data.timeRemainingInPhase;

                switch (data.feederCycleState) {
                    case 0: // FEED_OFF (długa przerwa)
                        feederText = "PRZERWA";
                        progressBarColor = 'var(--feeder-pause-color)';
                        break;
                    case 1: // FEED_FORWARD (podawanie do przodu)
                        feederText = "PODAWANIE";
                        progressBarColor = 'var(--feeder-forward-color)';
                        break;
                    case 2: // FEED_SHORT_PAUSE (krótka przerwa)
                        feederText = "KRÓTKA PRZERWA";
                        progressBarColor = 'var(--feeder-pause-color)';
                        break;
                    case 3: // FEED_REVERSE (cofanie podajnika)
                        feederText = "COFANIE";
                        progressBarColor = 'var(--feeder-reverse-color)';
                        break;
                }
                
                feederStatus.innerHTML = `<span class="status-indicator ${data.feeder_active || data.reverseFeederActive ? 'status-active' : 'status-inactive'}"></span> PODAJNIK: ${feederText}`;
                feederStatus.classList.toggle('on', data.feeder_active || data.reverseFeederActive);
                feederStatus.classList.toggle('off', !(data.feeder_active || data.reverseFeederActive));

                const progressPercentage = totalPhaseDuration > 0 ? ((totalPhaseDuration - remainingTimeInPhase) / totalPhaseDuration) * 100 : 0;
                cycleProgressBar.style.width = `${progressPercentage}%`;
                cycleProgressBar.style.background = progressBarColor;

                cycleTimer.textContent = `${remainingTimeInPhase}s do końca`;
            }

            if (pelletAmount) {
                pelletAmount.textContent = data.currentPelletConsumptionRate.toFixed(2);
            }

            const avgConsumption = calculateAverageConsumption(60); // Calculate for last 60 minutes
            averagePelletConsumptionDisplay.textContent = avgConsumption.toFixed(2) + 'kg/h';

            maintenanceStatus.textContent = data.maintenance_mode ? "AKTYWNY" : "NIEAKTYWNY";
            maintenanceStatus.classList.toggle('maintenance-active', data.maintenance_mode);
            maintenanceStatus.classList.toggle('maintenance-inactive', !data.maintenance_mode);
            maintenanceStatusBadge.className = 'status-badge ' + (data.maintenance_mode ? 'status-good' : 'status-error');
            
            ashCleaningStatus.textContent = data.ash_cleaning ? "AKTYWNE" : "NIE";
            cleaningStatusBadge.className = 'status-badge ' + (data.ash_cleaning ? 'status-warning' : 'status-good');

            igniterTempDisplay.textContent = data.igniterTemp ? `${data.igniterTemp.toFixed(1)}°C` : 'N/A';
            igniterStatusText.textContent = data.igniterState;
            igniterStatusText.className = `ignition-status ${data.igniterState}`;

            if (data.igniterState === 'heating' || data.igniterState === 'ready') {
                igniterIndicator.style.display = 'flex';
                igniterIndicator.className = `igniter-indicator ${data.igniterState}`;
            } else {
                igniterIndicator.style.display = 'none';
            }

            feedTimeInput.value = data.feedOnTime || 5;
            pauseTimeInput.value = data.feedOffTime || 30;
            maintenanceFeedInput.value = data.maintenanceFeedOnTime || 2;
            maintenancePauseInput.value = data.maintenanceFeedOffTime || 60;
            
            blowerManualToggle.checked = data.blowerManualControl || false;
            blowerManualControlsDiv.style.display = data.blowerManualControl ? 'block' : 'none';

            blowerWorkPowerSlider.value = data.blowerWorkPower || 70;
            blowerWorkPowerDisplay.textContent = `${data.blowerWorkPower || 70}%`;
            blowerPurgeManualPowerSlider.value = data.blowerPurgeManualPower || 50;
            blowerPurgeManualPowerDisplay.textContent = `${data.blowerPurgeManualPower || 50}%`;
            blowerMaintenanceManualPowerSlider.value = data.blowerMaintenanceManualPower || 30;
            blowerMaintenanceManualPowerDisplay.textContent = `${data.blowerMaintenanceManualPower || 30}%`;

            blowerPowerSlider.value = data.effectiveBlowerPower || 0;
            blowerPowerDisplay.textContent = `${data.effectiveBlowerPower || 0}%`;


            blowerPurgeToggle.checked = data.blowerPurgeMode || false;
            blowerPurgeTimesContainer.style.display = data.blowerPurgeMode ? 'flex' : 'none';
            blowerPurgeOnInput.value = data.blowerPurgeOnTime || 5;
            blowerPurgeOffInput.value = data.blowerPurgeOffTime || 300;

            sessionUptimeDisplay.textContent = formatTime(data.session_uptime);
            totalUptimeDisplay.textContent = formatTime(data.total_uptime);

            rssi.textContent = `${data.rssi}dBm`;
            ipAddr.textContent = data.ip || "0.0.0.0";
            
            if (data.mqtt_connected) {
                mqttStatusText.textContent = "Połączono";
                mqttStatusIndicator.classList.remove('mqtt-disconnected');
                mqttStatusIndicator.classList.add('connected');
            } else {
                mqttStatusText.textContent = "Brak połączenia";
                mqttStatusIndicator.classList.remove('connected');
                mqttStatusIndicator.classList.add('mqtt-disconnected');
            }
            
            if (temperatureChartInstance && consumptionChartInstance && data.timestamp_ms) {
                addChartDataPoint(data);
                if (chartData.pellet_consumption.length > 0) {
                    const firstTimestamp = chartData.pellet_consumption[0].x;
                    const lastTimestamp = chartData.pellet_consumption[chartData.pellet_consumption.length - 1].x;

                    consumptionChartInstance.data.datasets[1].data = [
                        { x: firstTimestamp, y: avgConsumption },
                        { x: lastTimestamp, y: avgConsumption }
                    ];
                    consumptionChartInstance.update();
                }
            } else {
                console.warn("Chart not initialized or timestamp missing, skipping addChartDataPoint.");
            }

            const dailyData = aggregateDailyConsumption(chartData.pellet_consumption);
            dailyConsumptionChartInstance.data.labels = dailyData.labels;
            dailyConsumptionChartInstance.data.datasets[0].data = dailyData.data;
            dailyConsumptionChartInstance.update();

            const monthlyData = aggregateMonthlyConsumption(chartData.pellet_consumption);
            monthlyConsumptionChartInstance.data.labels = monthlyData.labels;
            monthlyConsumptionChartInstance.data.datasets[0].data = monthlyData.data;
            monthlyConsumptionChartInstance.update();

            const yearlyData = aggregateYearlyConsumption(chartData.pellet_consumption);
            yearlyConsumptionChartInstance.data.labels = yearlyData.labels;
            yearlyConsumptionChartInstance.data.datasets[0].data = yearlyData.data;
            yearlyConsumptionChartInstance.update();

            const globalData = aggregateGlobalConsumption(chartData.pellet_consumption);
            globalConsumptionChartInstance.data.labels = globalData.labels;
            globalConsumptionChartInstance.data.datasets[0].data = globalData.data;
            globalConsumptionChartInstance.update();


            const currentBurnerHoursParts = burnerHoursDisplay.textContent.split(':');
            let currentBurnerMinutes = parseInt(currentBurnerHoursParts[0]) * 60 + parseInt(currentBurnerHoursParts[1]);
            
            if (data.flame && data.power === "ON") { // Zmieniono na "ON"
                currentBurnerMinutes += (3 / 60);
            }
            const newBurnerHours = Math.floor(currentBurnerMinutes / 60);
            const newBurnerMinutes = Math.floor(currentBurnerMinutes % 60);
            burnerHoursDisplay.textContent = `${newBurnerHours.toString().padStart(2, '0')}:${newBurnerMinutes.toString().padStart(2, '0')}`;

            calculateCost();

            const efficiency = Math.min(100, (data.water_temp / 85) * 100).toFixed(0);
            efficiencyFill.style.width = `${efficiency}%`;
            efficiencyLabel.textContent = `${efficiency}% Wydajność`;

            const cleanHours = Math.floor(data.time_to_clean / 3600);
            const cleanMinutes = Math.floor((data.time_to_clean % 3600) / 60);
            const cleanSeconds = Math.floor(data.time_to_clean % 60);
            cleanCountdownDisplay.textContent = 
                `${cleanHours.toString().padStart(2, '0')}:${cleanMinutes.toString().padStart(2, '0')}:${cleanSeconds.toString().padStart(2, '0')}`;
        }
        
        // --- Wysyłanie komend do ESP32 (teraz przez MQTT) ---
        function sendCommand(cmd, value = null) {
            const payload = value !== null ? {command: cmd, value: value} : {command: cmd};
            
            // Wysyłamy komendę do ESP32 przez MQTT na temat 'control'
            // To zastępuje poprzednie wywołania HTTP POST
            if (client && client.connected) {
                publishMqttMessage(MQTT_TOPICS.control, JSON.stringify(payload));
            } else {
                appendMqttLog("ERROR", "Nie połączono z brokerem MQTT, komenda nie wysłana!");
                console.error("MQTT client not connected, command not sent via MQTT.");
                // Możesz dodać tu logikę fallbacku na HTTP, jeśli chcesz zachować obie metody
            }
            // Logic for reset_history and reset_session_uptime handled via MQTT now
            if (cmd === 'reset_history') {
                resetMessageDiv.textContent = 'Komenda resetowania danych wysłana. Odśwież stronę po chwili.';
                resetMessageDiv.style.color = 'var(--warning)';
                // initChart([]); // Możesz pozostawić to, aby UI od razu się wyczyściło
            } else if (cmd === 'reset_session_uptime') {
                console.log('Komenda resetowania czasu pracy sesji wysłana.');
            }
        }
        
        // --- Event Handlers (BEZ ZMIAN W HTML/STRUKTURZE) ---
        // Zapewnienie, że element autoCleanToggle istnieje, zanim spróbujemy dodać do niego EventListener
        const autoCleanToggle = document.getElementById('auto-clean-toggle');
        if (autoCleanToggle) {
            autoCleanToggle.addEventListener('change', () => {
                sendCommand('autoclean', autoCleanToggle.checked);
            });
        }

        powerBtn.addEventListener('click', () => {
            // Logika ON/OFF jest teraz w updateUI na podstawie danych z ESP32,
            // tutaj tylko wysyłamy komendę 'power' i ESP32 przełącza swój stan
            const currentStateText = powerBtn.textContent.trim();
            let newPowerState;
            if (currentStateText.includes("WŁĄCZONY")) {
                newPowerState = "OFF";
            } else {
                newPowerState = "ON";
            }
            // Wysyłamy prosty komunikat ON/OFF
            publishMqttMessage(MQTT_TOPICS.power, newPowerState);
        });
        
        targetSlider.addEventListener('input', () => {
            const value = parseInt(targetSlider.value);
            targetDisplay.textContent = value + '°C';
            // Wysyłamy komendę na bieżąco, aby była bardziej responsywna
            publishMqttMessage(MQTT_TOPICS.targetTemp, value.toString());
        });

        ashBtn.addEventListener('click', () => {
            sendCommand('clean');
        });
        
        updateCleanBtn.addEventListener('click', () => {
            const hours = parseInt(cleanHoursInput.value);
            const minutes = parseInt(cleanMinutesInput.value);
            const seconds = parseInt(cleanSecondsInput.value);
            const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;
            sendCommand('set_clean_time', totalSeconds);
        });

        feedTimeInput.addEventListener('change', () => {
            const onTime = parseInt(feedTimeInput.value);
            const offTime = parseInt(pauseTimeInput.value);
            sendCommand('set_feed_times', { on: onTime, off: offTime });
        });

        pauseTimeInput.addEventListener('change', () => {
            const onTime = parseInt(feedTimeInput.value);
            const offTime = parseInt(pauseTimeInput.value);
            sendCommand('set_feed_times', { on: onTime, off: offTime });
        });

        maintenanceFeedInput.addEventListener('change', () => {
            const maintenanceOnTime = parseInt(maintenanceFeedInput.value);
            const maintenanceOffTime = parseInt(maintenancePauseInput.value);
            sendCommand('set_maintenance_feed_times', { on: maintenanceOnTime, off: maintenanceOffTime });
        });

        maintenancePauseInput.addEventListener('change', () => {
            const maintenanceOnTime = parseInt(maintenanceFeedInput.value);
            const maintenanceOffTime = parseInt(maintenancePauseInput.value);
            sendCommand('set_maintenance_feed_times', { on: maintenanceOnTime, off: maintenanceOffTime });
        });

        blowerManualToggle.addEventListener('change', () => {
            const isChecked = blowerManualToggle.checked;
            sendCommand('set_blower_manual', isChecked);
            blowerManualControlsDiv.style.display = isChecked ? 'block' : 'none';
        });

        blowerWorkPowerSlider.addEventListener('input', () => {
            const value = parseInt(blowerWorkPowerSlider.value);
            blowerWorkPowerDisplay.textContent = value + '%';
        });
        blowerWorkPowerSlider.addEventListener('change', () => {
            const value = parseInt(blowerWorkPowerSlider.value);
            sendCommand('set_blower_work_power', value);
        });

        blowerPurgeManualPowerSlider.addEventListener('input', () => {
            const value = parseInt(blowerPurgeManualPowerSlider.value);
            blowerPurgeManualPowerDisplay.textContent = value + '%';
        });
        blowerPurgeManualPowerSlider.addEventListener('change', () => {
            const value = parseInt(blowerPurgeManualPowerSlider.value);
            sendCommand('set_blower_purge_manual_power', value);
        });

        blowerMaintenanceManualPowerSlider.addEventListener('input', () => { 
            const value = parseInt(blowerMaintenanceManualPowerSlider.value);
            blowerMaintenanceManualPowerDisplay.textContent = value + '%';
        });
        blowerMaintenanceManualPowerSlider.addEventListener('change', () => { 
            const value = parseInt(blowerMaintenanceManualPowerSlider.value);
            sendCommand('set_blower_maintenance_manual_power', value);
        });

        blowerPurgeToggle.addEventListener('change', () => {
            const isChecked = blowerPurgeToggle.checked;
            sendCommand('set_blower_purge_mode', isChecked);
            blowerPurgeTimesContainer.style.display = isChecked ? 'flex' : 'none';
        });

        blowerPurgeOnInput.addEventListener('change', () => {
            const onTime = parseInt(blowerPurgeOnInput.value);
            const offTime = parseInt(blowerPurgeOffInput.value);
            sendCommand('set_blower_purge_times', { on: onTime, off: offTime });
        });

        blowerPurgeOffInput.addEventListener('change', () => {
            const onTime = parseInt(blowerPurgeOnInput.value);
            const offTime = parseInt(blowerPurgeOffInput.value);
            sendCommand('set_blower_purge_times', { on: onTime, off: offTime });
        });

        resetHistoryBtn.addEventListener('click', () => {
            const password = resetPasswordInput.value;
            sendCommand('reset_history', password); // Wysyła hasło do ESP32
        });

        resetSessionUptimeBtn.addEventListener('click', () => {
            sendCommand('reset_session_uptime');
        });

        // Chart switching (for temperature chart's individual datasets)
        document.querySelectorAll('#temperature-chart-toggles .dataset-toggle').forEach(button => { 
            button.addEventListener('click', function() {
                const chartType = this.dataset.chart;
                const datasetIndex = chartDatasetMap[chartType];
                
                if (datasetIndex !== undefined) {
                    const isHidden = temperatureChartInstance.isDatasetVisible(datasetIndex);
                    temperatureChartInstance.setDatasetVisibility(datasetIndex, !isHidden);
                    this.classList.toggle('active', !isHidden);
                    temperatureChartInstance.update();
                }
            });
        });

        // Chart switching (for main chart types)
        document.querySelectorAll('#main-chart-switcher .chart-switch').forEach(button => {
            button.addEventListener('click', function() {
                const chartType = this.dataset.chartType;
                document.querySelectorAll('#main-chart-switcher .chart-switch').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                // Hide all chart containers
                chartContainerTemp.style.display = 'none';
                chartContainerConsumption.style.display = 'none';
                chartContainerDailyConsumption.style.display = 'none';
                chartContainerMonthlyConsumption.style.display = 'none';
                chartContainerYearlyConsumption.style.display = 'none';
                chartContainerGlobalConsumption.style.display = 'none';

                // Hide/show temperature toggles
                temperatureChartToggles.style.display = 'none';

                // Show the selected chart container and reset zoom for line charts
                switch (chartType) {
                    case 'temperature':
                        chartContainerTemp.style.display = 'block';
                        temperatureChartToggles.style.display = 'flex';
                        if (temperatureChartInstance) temperatureChartInstance.resetZoom();
                        if (temperatureChartInstance) temperatureChartInstance.resize();
                        break;
                    case 'consumption':
                        chartContainerConsumption.style.display = 'block';
                        if (consumptionChartInstance) consumptionChartInstance.resetZoom();
                        if (consumptionChartInstance) consumptionChartInstance.resize();
                        break;
                    case 'daily-consumption':
                        chartContainerDailyConsumption.style.display = 'block';
                        if (dailyConsumptionChartInstance) dailyConsumptionChartInstance.resize();
                        break;
                    case 'monthly-consumption':
                        chartContainerMonthlyConsumption.style.display = 'block';
                        if (monthlyConsumptionChartInstance) monthlyConsumptionChartInstance.resize();
                        break;
                    case 'yearly-consumption':
                        chartContainerYearlyConsumption.style.display = 'block';
                        if (yearlyConsumptionChartInstance) yearlyConsumptionChartInstance.resize();
                        break;
                    case 'global-consumption':
                        chartContainerGlobalConsumption.style.display = 'block';
                        if (globalConsumptionChartInstance) globalConsumptionChartInstance.resize();
                        break;
                }
            });
        });

        // Chart zoom controls (for temperature chart)
        document.getElementById('zoom-in').addEventListener('click', () => { if (temperatureChartInstance) temperatureChartInstance.zoom(1.1); });
        document.getElementById('zoom-out').addEventListener('click', () => { if (temperatureChartInstance) temperatureChartInstance.zoom(0.9); });
        document.getElementById('zoom-reset').addEventListener('click', () => { if (temperatureChartInstance) temperatureChartInstance.resetZoom(); });

        // Zoom controls for consumption chart
        document.getElementById('consumption-zoom-in').addEventListener('click', () => { if (consumptionChartInstance) consumptionChartInstance.zoom(1.1); });
        document.getElementById('consumption-zoom-out').addEventListener('click', () => { if (consumptionChartInstance) consumptionChartInstance.zoom(0.9); });
        document.getElementById('consumption-zoom-reset').addEventListener('click', () => { if (consumptionChartInstance) consumptionChartInstance.resetZoom(); });

        // History range buttons (placeholder for future implementation)
        historyRangeButtons.forEach(button => {
            button.addEventListener('click', function() {
                historyRangeButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                const range = this.dataset.range;
                console.log(`Selected history range: ${range}`);
            });
        });

        // Cost calculation logic
        function calculateCost() {
            const price = parseFloat(pelletPriceInput.value);
            const actualConsumptionRate = parseFloat(pelletAmount.textContent);
            
            const burnerHoursParts = burnerHoursDisplay.textContent.split(':');
            const burnerHoursTotal = parseInt(burnerHoursParts[0]) + (parseInt(burnerHoursParts[1]) / 60);

            if (!isNaN(price) && !isNaN(actualConsumptionRate) && !isNaN(burnerHoursTotal)) {
                const estimatedCost = price * actualConsumptionRate * burnerHoursTotal;
                estimatedCostDisplay.textContent = `${estimatedCost.toFixed(2)} PLN`;
                totalCalculatedCost.textContent = `${estimatedCost.toFixed(2)} PLN`;
            } else {
                estimatedCostDisplay.textContent = `N/A`;
                totalCalculatedCost.textContent = `N/A`;
            }
        }

        pelletPriceInput.addEventListener('input', calculateCost);

        // Initial state fetch and MQTT connection
        document.addEventListener('DOMContentLoaded', () => {
            // Połączenie/rozłączenie MQTT
            mqttConnectBtn.addEventListener('click', connectMQTT);
            mqttDisconnectBtn.addEventListener('click', disconnectMQTT);

            // ZAKOMENTOWANE: Usunięto wywołania fetch('/history') i fetch('/state') oraz setInterval,
            // ponieważ aplikacja webowa ma polegać WYŁĄCZNIE na komunikacji MQTT.
            // Te wywołania próbowałyby łączyć się lokalnie z ESP32, co nie działa, gdy strona jest na GitHub Pages.

            // AUTOMATYCZNE POŁĄCZENIE MQTT PO ZAŁADOWANIU STRONY (dla połączenia internetowego)
            // Uruchomienie połączenia MQTT po załadowaniu strony
            connectMQTT();
        });
    </script>
</body>
</html>
